<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAKAMI PRO - Cloud PDV</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* LAYOUT QUE VOC√ä APROVOU - MANTIDO INTEGRALMENTE */
body{margin:0;font-family:'Roboto',sans-serif;background:#f4f6f8;color:#333}
header{background:linear-gradient(90deg,#7c3aed,#d946ef);color:#fff;padding:20px;text-align:center;font-size:26px;font-weight:700}
.container{max-width:1400px;margin:auto;padding:20px}
.card{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,.05);transition:.3s}
.card:hover{box-shadow:0 6px 25px rgba(0,0,0,.1)}
input,select,button{padding:10px;margin:5px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc; font-family:inherit;}
button{background:#7c3aed;color:#fff;border:none;cursor:pointer;transition:0.2s;font-weight:500}
button:hover{background:#6b21a8}
button:disabled{background:#94a3b8; cursor:not-allowed;}
button.danger{background:#ef4444;}
button.success{background:#10b981;}
button.print{background:#475569;}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{padding:12px 10px;border-bottom:1px solid #ddd;text-align:left}
th{background:#f3f3f3}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px;margin-bottom:20px}
.box{padding:20px;border-radius:10px;text-align:center;color:#fff;font-weight:700;font-size:14px;display:flex;flex-direction:column;align-items:center;justify-content:center}
.box span{font-size:22px;margin-top:8px}
#investimento{background:#f59e0b} #valorEstoque{background:#6366f1} #receitas{background:#8b5cf6} #vendasAReceber{background:#0284c7} #despesas{background:#ef4444} #lucro{background:#10b981} #margem{background:#14b8a6}
.hidden{display:none !important}
.flex{display:flex;gap:10px;flex-wrap:wrap; align-items:center;}
.flex input, .flex select{flex:1; min-width: 150px;}
.total-carrinho{font-weight:700;text-align:center;font-size:22px; color: #7c3aed; margin-bottom: 15px;}
.card-title{font-size:18px;font-weight:700;margin-bottom:15px; border-bottom: 2px solid #f4f6f8; padding-bottom: 10px; display:flex; justify-content:space-between; align-items:center;}
.acoes-btn {display: flex; gap: 5px; align-items: center;}
.acoes-btn button {padding: 6px 10px; font-size: 12px; margin: 0; width: auto;}
.lucro-tag { font-size: 11px; background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-weight: bold; border: 1px solid #86efac; }
#reciboImpressao { display: none; }
@media print {
    body * { visibility: hidden; }
    #reciboImpressao, #reciboImpressao * { visibility: visible; }
    #reciboImpressao { position: absolute; left: 0; top: 0; width: 100%; max-width: 300px; display: block; font-family: monospace; }
}
</style>
</head>
<body>

<div id="reciboImpressao"></div>

<header>LAKAMI PRO - Cloud PDV</header>
<div class="container">

<div id="loginBox" class="card" style="max-width: 400px; margin: 50px auto;">
<h3 style="text-align:center">Acesso Cloud</h3>
<input type="text" id="user" placeholder="Usu√°rio">
<input type="password" id="pass" placeholder="Senha">
<button id="btnLogin" onclick="login()">Entrar e Sincronizar</button>
<p id="loginMsg" style="font-size:12px; color:#10b981; text-align:center"></p>
</div>

<div id="sistema" class="hidden">

<div class="card">
<h3 class="card-title">Resumo Financeiro Real</h3>
<div class="grid">
<div class="box" id="investimento">Custo do Estoque<span>R$ 0,00</span></div>
<div class="box" id="valorEstoque">Venda Projetada<span>R$ 0,00</span></div>
<div class="box" id="receitas">Vendas Recebidas<span>R$ 0,00</span></div>
<div class="box" id="vendasAReceber">Vendas a Receber<span>R$ 0,00</span></div>
<div class="box" id="despesas">Despesas<span>R$ 0,00</span></div>
<div class="box" id="lucro">Lucro L√≠quido<span>R$ 0,00</span></div>
<div class="box" id="margem">Margem Global<span>0%</span></div>
</div>
</div>

<div class="card">
<h3 class="card-title">Gest√£o de Produtos</h3>
<div class="flex">
<input id="nomeProd" placeholder="Nome do Produto">
<select id="tamProd"></select>
<input id="compraProd" type="number" step="0.01" placeholder="Custo">
<input id="vendaProd" type="number" step="0.01" placeholder="Venda">
<input id="qtdProd" type="number" placeholder="Estoque">
<button id="btnAddProd" onclick="addProduto()">Salvar Produto</button>
</div>
<table style="margin-top:15px">
<thead><tr><th>Produto</th><th>Tam</th><th>Estoque</th><th>Custo</th><th>Venda</th><th>A√ß√µes</th></tr></thead>
<tbody id="listaProd"></tbody>
</table>
</div>

<div class="card">
    <h3 class="card-title">Ponto de Venda (PDV)</h3>
    <div style="display:flex; gap:20px; flex-wrap:wrap">
        <div style="flex:2; min-width:300px">
            <div class="flex">
                <select id="selectProd" style="flex:3"><option value="">Selecione o Produto...</option></select>
                <input id="qtdVenda" type="number" value="1" style="max-width:80px; text-align:center">
                <button onclick="addCarrinho()">Inserir</button>
            </div>
            <table class="carrinho-table" style="margin-top:15px">
                <thead><tr><th>Produto</th><th>Qtd</th><th>Unit.</th><th>Subtotal</th><th>A√ß√µes</th></tr></thead>
                <tbody id="carrinho"></tbody>
            </table>
        </div>
        <div style="flex:1; min-width:280px; background:#f8fafc; padding:20px; border-radius:8px; border:1px solid #e2e8f0; display:flex; flex-direction:column; gap:10px">
            <div class="total-carrinho" id="totalCarrinho">Total: R$ 0,00</div>
            <select id="selectCliente"><option value="">Cliente Padr√£o (Avulso)</option></select>
            <select id="formaPag" onchange="tratarRegrasPagamento()">
                <option value="PIX">PIX</option>
                <option value="√Ä vista (Dinheiro)">√Ä vista (Dinheiro)</option>
                <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                <option value="Prazo">A Prazo / Fiado</option>
            </select>
            <div id="boxDesconto" style="display:flex; flex-direction:column; gap:5px">
                <label style="font-size:13px; font-weight:700; color:#10b981">Desconto (%)</label>
                <input type="number" id="valorDesconto" value="0" oninput="atualizarCarrinho()">
            </div>
            <input type="date" id="dataPrazo" class="hidden">
            <button onclick="finalizarVenda()" class="success" style="padding:15px">Finalizar Venda</button>
        </div>
    </div>
</div>

<div class="card">
<h3 class="card-title">Hist√≥rico de Vendas <button onclick="fechamentoCaixa()" style="background:#475569; font-size:12px; width:auto; padding:5px 15px">üìä Relat√≥rio do Dia</button></h3>
<table>
<thead><tr><th>Data</th><th>Produto</th><th>Cliente</th><th>Total</th><th>Saldo Devedor</th><th>Lucro Item</th><th>A√ß√µes</th></tr></thead>
<tbody id="listaVendas"></tbody>
</table>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHwt8eGsCv2dnKAYQa0iaqWoHyGxl5V14",
  authDomain: "lakami-pro.firebaseapp.com",
  projectId: "lakami-pro",
  storageBucket: "lakami-pro.firebasestorage.app",
  messagingSenderId: "966421239270",
  appId: "1:966421239270:web:60d9b7c79ba700c515f227"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const formatCurrency = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
const el = (id) => document.getElementById(id);

const tamSelect = el("tamProd");
tamSelect.innerHTML = `<option value="">Tamanho...</option><option value="√önico">√önico</option>`;
for(let i=1; i<=12; i++){ tamSelect.innerHTML += `<option value="${i}">${i}</option>`; }

let produtos = [], clientes = [], vendas = [], carrinhoArr = [];
let editProdId=null;

async function puxarDadosNuvem() {
    const fetchCol = async (n) => {
        const snap = await getDocs(collection(db, n));
        return snap.docs.map(d => d.data());
    };
    produtos = await fetchCol("produtos");
    vendas = await fetchCol("vendas");
}

async function salvarFirebase(col, item) { await setDoc(doc(db, col, item.id.toString()), item); }
async function deletarFirebase(col, id) { await deleteDoc(doc(db, col, id.toString())); }

window.login = async function(){
    if(el("user").value==="admin" && el("pass").value==="1234"){ 
        el("btnLogin").disabled = true; el("loginMsg").innerText = "Sincronizando...";
        await puxarDadosNuvem();
        el("loginBox").classList.add("hidden"); el("sistema").classList.remove("hidden");
        atualizar(); 
    } else alert("Senha errada!");
};

window.addProduto = function(){
    const n = el("nomeProd").value; const t = el("tamProd").value;
    const c = parseFloat(el("compraProd").value); const v = parseFloat(el("vendaProd").value); const q = parseInt(el("qtdProd").value);
    if(!n || isNaN(c)) return alert("Preencha!");
    let obj = editProdId ? produtos.find(x => x.id == editProdId) : {id: Date.now()};
    obj.nome=n; obj.tam=t; obj.compra=c; obj.venda=v; obj.qtd=q;
    if(!editProdId) produtos.push(obj);
    salvarFirebase("produtos", obj);
    editProdId=null; el("nomeProd").value=""; el("compraProd").value=""; el("vendaProd").value=""; el("qtdProd").value="";
    atualizar();
};

window.addCarrinho = function(){
    let pid = el("selectProd").value; if(!pid) return;
    let p = produtos.find(x => x.id == pid);
    let q = parseInt(el("qtdVenda").value);
    carrinhoArr.push({id: p.id, nome: `${p.nome} (${p.tam})`, qtd: q, venda: p.venda, compra: p.compra});
    window.atualizarCarrinho();
};

window.atualizarCarrinho = function(){
    let tb = el("carrinho"); tb.innerHTML = ""; let st = 0;
    carrinhoArr.forEach((item, i) => {
        let sub = item.qtd * item.venda; st += sub;
        tb.innerHTML += `<tr><td>${item.nome}</td><td>${item.qtd}</td><td>${formatCurrency(item.venda)}</td><td>${formatCurrency(sub)}</td><td><button class="danger" onclick="removerCarrinho(${i})">X</button></td></tr>`;
    });
    let desc = parseFloat(el("valorDesconto").value) || 0;
    el("totalCarrinho").innerText = "Total: " + formatCurrency(st * (1 - desc/100));
};

window.finalizarVenda = function(){
    if(!carrinhoArr.length) return alert("Vazio!");
    let f = el("formaPag").value; let desc = parseFloat(el("valorDesconto").value) || 0;
    let dv = el("dataPrazo").value;
    carrinhoArr.forEach(item => {
        let p = produtos.find(x => x.id == item.id);
        if(p) { p.qtd -= item.qtd; salvarFirebase("produtos", p); }
        let total = (item.venda * item.qtd) * (1 - (desc/100));
        let vObj = {
            id: Date.now() + Math.random(), data: new Date().toISOString(),
            produto: item.nome, cliente: el("selectCliente").value || "Avulso",
            total: total, custo: item.compra * item.qtd,
            saldoDevedor: (f === "Prazo" ? total : 0),
            forma: f, produtoId: item.id, quantidade: item.qtd,
            baixas: [] // Hist√≥rico de pagamentos parciais
        };
        vendas.push(vObj); salvarFirebase("vendas", vObj);
    });
    carrinhoArr = []; el("valorDesconto").value = "0"; window.atualizarCarrinho(); atualizar();
};

// NOVA FUN√á√ÉO: BAIXA PARCIAL COM DIGITA√á√ÉO (A PEDIDO)
window.darBaixaVenda = function(id){
    let v = vendas.find(x => x.id == id);
    let valorSugerido = v.saldoDevedor;
    let pg = parseFloat(prompt(`Saldo Devedor: ${formatCurrency(v.saldoDevedor)}\nDigite o valor que o cliente est√° pagando:`, valorSugerido));
    
    if(!isNaN(pg) && pg > 0){
        if(pg > v.saldoDevedor) return alert("Valor maior que a d√≠vida!");
        
        v.saldoDevedor = Number((v.saldoDevedor - pg).toFixed(2));
        if(!v.baixas) v.baixas = [];
        v.baixas.push({ valor: pg, data: new Date().toISOString() });
        
        if(v.saldoDevedor === 0) v.forma = "Prazo (Quitado)";
        
        salvarFirebase("vendas", v);
        atualizar();
    }
};

// NOVA FUN√á√ÉO: FECHAMENTO DE CAIXA (A PEDIDO)
window.fechamentoCaixa = function(){
    let hoje = new Date().toLocaleDateString();
    let pix = 0, din = 0, deb = 0, cre = 0, fiadoGerado = 0, baixasRecebidas = 0;

    vendas.forEach(v => {
        let dataV = new Date(v.data).toLocaleDateString();
        if(dataV === hoje){
            if(v.forma === "PIX") pix += v.total;
            if(v.forma.includes("Dinheiro")) din += v.total;
            if(v.forma.includes("D√©bito")) deb += v.total;
            if(v.forma === "Cart√£o de Cr√©dito") cre += v.total;
            if(v.forma === "Prazo") fiadoGerado += v.total;
        }
        // Soma baixas parciais feitas hoje (mesmo de vendas antigas)
        if(v.baixas){
            v.baixas.forEach(b => {
                if(new Date(b.data).toLocaleDateString() === hoje) baixasRecebidas += b.valor;
            });
        }
    });

    let totalGeral = pix + din + deb + cre + baixasRecebidas;

    alert(`FECHAMENTO LAKAMI - ${hoje}\n\n` +
          `PIX: ${formatCurrency(pix)}\n` +
          `Dinheiro: ${formatCurrency(din)}\n` +
          `Cart√£o D√©bito: ${formatCurrency(deb)}\n` +
          `Cart√£o Cr√©dito: ${formatCurrency(cre)}\n` +
          `Baixas Fiado (Recebido): ${formatCurrency(baixasRecebidas)}\n\n` +
          `TOTAL EM CAIXA: ${formatCurrency(totalGeral)}\n\n` +
          `Fiado Gerado Hoje (N√£o somado): ${formatCurrency(fiadoGerado)}`);
};

window.excluirVenda = function(id){
    if(confirm("Estornar?")){
        let v = vendas.find(x => x.id == id);
        let p = produtos.find(x => x.id == v.produtoId);
        if(p) { p.qtd += v.quantidade; salvarFirebase("produtos", p); }
        vendas = vendas.filter(x => x.id != id); deletarFirebase("vendas", id); atualizar();
    }
};

window.imprimirRecibo = function(id){
    let v = vendas.find(x => x.id == id);
    el("reciboImpressao").innerHTML = `<div style="text-align:center"><h2>LAKAMI</h2><p>Moda Infantil | @lakami_kids</p></div><hr><p>Data: ${new Date(v.data).toLocaleDateString()}</p><p>Cliente: ${v.cliente}</p><p>${v.quantidade}x ${v.produto} - ${formatCurrency(v.total)}</p><p>Pagamento: ${v.forma}</p>`;
    window.print();
};

window.tratarRegrasPagamento = () => {
    let f = el("formaPag").value;
    el("dataPrazo").className = f === "Prazo" ? "" : "hidden";
    el("boxDesconto").style.display = (f === "PIX" || f === "√Ä vista (Dinheiro)") ? "flex" : "none";
};

function atualizar(){
    el("listaProd").innerHTML = ""; el("selectProd").innerHTML = '<option value="">Selecione...</option>';
    let inv=0, est=0, vr=0, varc=0, cv=0;

    produtos.forEach(p => {
        inv += p.compra * p.qtd; est += p.venda * p.qtd;
        el("listaProd").innerHTML += `<tr><td>${p.nome}</td><td>${p.tam}</td><td>${p.qtd}</td><td>${formatCurrency(p.compra)}</td><td>${formatCurrency(p.venda)}</td><td><button onclick="editarProduto(${p.id})">E</button><button class="danger" onclick="excluirProduto(${p.id})">X</button></td></tr>`;
        if(p.qtd > 0) el("selectProd").innerHTML += `<option value="${p.id}">${p.nome} (${p.tam})</option>`;
    });

    el("listaVendas").innerHTML = "";
    vendas.sort((a,b)=>new Date(b.data)-new Date(a.data)).forEach(v => {
        // Recebido = Total da venda - Saldo que ainda falta receber
        vr += (v.total - v.saldoDevedor); varc += v.saldoDevedor; cv += v.custo;
        let lucroVal = v.total - v.custo;
        let lucroPor = v.total > 0 ? (lucroVal/v.total*100).toFixed(1) : 0;
        let pendente = v.saldoDevedor > 0;

        el("listaVendas").innerHTML += `<tr>
            <td>${new Date(v.data).toLocaleDateString()}</td><td>${v.produto}</td><td>${v.cliente}</td>
            <td>${formatCurrency(v.total)}</td><td style="color:${pendente?'red':'green'}">${formatCurrency(v.saldoDevedor)}</td>
            <td><span class="lucro-tag">${formatCurrency(lucroVal)} (${lucroPor}%)</span></td>
            <td class="acoes-btn">
                ${pendente?`<button class="success" onclick="darBaixaVenda(${v.id})">$ Baixa</button>`:''}
                <button class="print" onclick="imprimirRecibo(${v.id})">üìÑ</button>
                <button class="danger" onclick="excluirVenda(${v.id})">X</button>
            </td>
        </tr>`;
    });

    el("investimento").children[0].innerText = formatCurrency(inv);
    el("valorEstoque").children[0].innerText = formatCurrency(est);
    el("receitas").children[0].innerText = formatCurrency(vr);
    el("vendasAReceber").children[0].innerText = formatCurrency(varc);
    el("lucro").children[0].innerText = formatCurrency((vr+varc)-cv);
    el("margem").children[0].innerText = (vr+varc > 0 ? (((vr+varc)-cv)/(vr+varc)*100).toFixed(1) : 0) + "%";
}

// Vincula√ß√£o Global
window.login = login; window.addProduto = addProduto; window.addCarrinho = addCarrinho; 
window.finalizarVenda = finalizarVenda; window.darBaixaVenda = darBaixaVenda;
window.excluirVenda = excluirVenda; window.imprimirRecibo = imprimirRecibo;
window.tratarRegrasPagamento = tratarRegrasPagamento; window.fechamentoCaixa = fechamentoCaixa;
window.removerCarrinho = (i) => { carrinhoArr.splice(i,1); window.atualizarCarrinho(); };
window.editarProduto = (id) => { let p=produtos.find(x=>x.id==id); el("nomeProd").value=p.nome; el("compraProd").value=p.compra; el("vendaProd").value=p.venda; el("qtdProd").value=p.qtd; editProdId=id; el("btnAddProd").innerText="Atualizar"; };
window.excluirProduto = (id) => { if(confirm("Excluir?")){ produtos=produtos.filter(x=>x.id!=id); deletarFirebase("produtos", id); atualizar(); } };
</script>
</body>
</html>