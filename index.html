<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LAKAMI KIDS - Cloud PDV 3.13</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
    --primary: #ff4eb5; 
    --primary-hover: #e83ea2;
    --secondary: #00c7d4; 
    --bg: #f0f7f8; 
    --sidebar: #ffffff; 
    --text-side: #334155; 
    --sidebar-active: #fdf2f8; 
}

*, *::before, *::after { box-sizing: border-box; }

body { margin:0; font-family:'Roboto',sans-serif; background:var(--bg); color:#333; display: flex; min-height: 100vh; overflow-x:hidden; width: 100%; }

/* MENU LATERAL LAKAMI (Desktop) */
.sidebar { width: 260px; background: var(--sidebar); color: var(--text-side); display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); position: fixed; height: 100vh; z-index: 1000; box-shadow: 2px 0 15px rgba(0,0,0,0.05); }
.sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: center; align-items: center;}
.sidebar-header img { max-width: 140px; border-radius: 12px; }
.nav-menu { flex: 1; padding: 15px 0; overflow-y: auto; display: flex; flex-direction: column; }
.nav-item { padding: 14px 25px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: 0.2s; border-left: 4px solid transparent; font-size: 14px; font-weight: 500; color: var(--text-side); }
.nav-item:hover { background: #f8fafc; color: var(--primary); }
.nav-item.active { background: var(--sidebar-active); border-left: 4px solid var(--primary); color: var(--primary); font-weight: 700; }

.main-content { flex: 1; margin-left: 260px; padding: 20px; transition: margin 0.3s ease; width: calc(100% - 260px); max-width: 100%; }
.section { display: none; animation: fadeIn 0.4s ease; }
.section.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

.card { background:#fff; border-radius:15px; padding:20px; margin-bottom:20px; box-shadow:0 4px 6px -1px rgba(0,0,0,.05); border: 1px solid #f1f5f9; }
input,select,button { padding:14px 12px; margin:5px 0; width:100%; border-radius:8px; border:1px solid #e2e8f0; font-family:inherit; outline: none; font-size: 14px; }
button { background:var(--primary); color:#fff; border:none; cursor:pointer; font-weight:600; transition: all 0.2s; }
button:hover { background:var(--primary-hover); transform: translateY(-1px); }
button:active { transform: scale(0.98); }
button:disabled { opacity: 0.7; cursor: not-allowed; }
button.danger { background:#ef4444; } button.success { background:#10b981; } button.warning { background:#f59e0b; } button.whatsapp { background:#25D366; }

.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:15px; margin-bottom:20px; }
.box { padding: 20px 15px; border-radius: 12px; text-align: center; color: #fff; font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: 600; display: flex; flex-direction: column; justify-content: center; }
.box span { font-size: 24px; font-weight: 700; margin-top: 8px; text-transform: none; letter-spacing: normal; }

#saldoConta{background:#3b82f6} #qtdEstoque{background:#8b5cf6} #qtdVendidas{background:#f43f5e} 
#investimento{background:#f59e0b} #valorEstoque{background:#6366f1} #receitas{background:var(--secondary)} 
#vendasAReceber{background:#0284c7} #despesas{background:#ef4444} #lucro{background:#10b981} #margem{background:#14b8a6}

.table-wrapper { width:100%; max-width: 100%; overflow-x:auto; border-radius: 10px; border: 1px solid #e2e8f0; -webkit-overflow-scrolling: touch; }
table { width:100%; border-collapse:collapse; font-size:14px; min-width: 650px; }
th,td { padding:14px; border-bottom:1px solid #e2e8f0; text-align:left; vertical-align: middle; }
th { background:#f8fafc; color: #64748b; font-weight: 600; white-space: nowrap; }

.acoes-btn { display: flex; gap: 6px; align-items: center; flex-wrap: nowrap; }
.btn-acao { padding: 0 12px; font-size: 12px; height: 36px; min-width: 78px; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; margin: 0; white-space: nowrap; }
.btn-acao-x { padding: 0; font-size: 13px; height: 36px; width: 36px; min-width: 36px; display: inline-flex; align-items: center; justify-content: center; border-radius: 6px; margin: 0; }

.flex { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
.flex input, .flex select { flex:1; min-width: 150px; margin:0; }
.flex button { width: auto; padding: 14px 25px; margin:0; }

.pdv-container { display: flex; gap: 20px; flex-wrap: wrap; }
.pdv-left { flex: 2; min-width: 0; } 
.pdv-right { flex: 1; min-width: 0; background: #f8fafc; padding: 25px; border-radius: 12px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; gap: 10px; height: fit-content; }
.total-carrinho { font-size: 32px; font-weight: 700; color: var(--secondary); text-align: center; margin-bottom: 10px; }

.custom-select { position: relative; flex: 1; background: #fff; border: 1px solid #ccc; border-radius: 8px; cursor: pointer; user-select: none; }
.select-selected { padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; min-height: 24px; font-size: 15px; }
.select-items { position: absolute; background: #fff; top: 100%; left: 0; right: 0; z-index: 999; border: 1px solid #ccc; border-radius: 8px; max-height: 400px; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.15); margin-top: 5px; }
.select-item-row { padding: 10px 15px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f1f5f9; transition: 0.2s; }
.select-item-row:last-child { border-bottom: none; }
.select-item-row:hover:not(.disabled) { background: #f8fafc; }
.select-item-row.disabled { opacity: 0.5; cursor: not-allowed; background: #f1f5f9; }
.select-item-row img { width: 45px; height: 45px; border-radius: 6px; object-fit: cover; border: 1px solid #e2e8f0; }
.select-item-placeholder { width: 45px; height: 45px; background: #e2e8f0; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #64748b; text-align: center; line-height: 1.1; }

.hidden { display:none !important; }
.lucro-tag { font-size: 11px; padding: 4px 8px; border-radius: 4px; font-weight: bold; background: #fdf2f8; color: #be185d; border: 1px solid #fbcfe8; }
.produto-img-box { display:flex; flex-direction:column; gap:8px; align-items:center; min-width: 120px; }
.produto-img-preview { width:110px; height:110px; border-radius:8px; object-fit:contain; border: 2px dashed #ccc; background:#f8fafc; }

.btn-tamanho { background: #f8fafc; color: #475569; border: 2px solid #cbd5e1; padding: 8px 12px; border-radius: 8px; font-size: 13px; margin:0; cursor:pointer; width:auto; font-weight:700; transition:0.2s; }
.btn-tamanho:hover { background: #e2e8f0; border-color: #94a3b8; }
.btn-tamanho.ativo { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 2px 8px rgba(255, 78, 181, 0.4); transform: scale(1.05); }
.grade-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr)); gap: 10px; width: 100%; }

@media (max-width: 1024px) {
    .sidebar { width: 70px; }
    .sidebar-header img { display: none; }
    .nav-item span { display: none; }
    .main-content { margin-left: 70px; width: calc(100% - 70px); }
    .nav-item { padding: 18px 0; justify-content: center; font-size: 20px; }
}

@media (max-width: 768px) {
    body { padding-bottom: 65px; display: block; }
    .sidebar { width: 100%; height: 65px; flex-direction: row; position: fixed; bottom: 0; left: 0; top: auto; box-shadow: 0 -4px 15px rgba(0,0,0,0.08); z-index: 5000; }
    .sidebar-header { display: none; }
    .nav-menu { flex-direction: row; overflow-x: auto; overflow-y: hidden; padding: 0 10px; align-items: center; justify-content: flex-start; -webkit-overflow-scrolling: touch; }
    .nav-item { padding: 0 18px; font-size: 22px; height: 100%; display: flex; align-items: center; justify-content: center; border-left: none; border-bottom: 4px solid transparent; }
    .nav-item.active { border-left: none; border-bottom: 4px solid var(--primary); background: transparent; }
    .main-content { margin-left: 0; width: 100%; max-width: 100%; padding: 10px; margin-bottom: 20px; }
    .grid { grid-template-columns: 1fr; gap: 10px; } 
    .box { padding: 15px 10px; }
    .box span { font-size: 20px; }
    .produto-img-box { width: 100%; flex-direction: row; justify-content: flex-start; }
    .produto-img-preview { width: 80px; height: 80px; }
    .flex { flex-direction: column; align-items: stretch; gap: 10px; }
    .flex input, .flex select { width: 100%; min-width: 0; margin: 0; }
    .flex button { width: 100%; margin: 0; padding: 16px; } 
    .pdv-container { flex-direction: column; gap: 15px; }
    .pdv-left, .pdv-right { width: 100%; min-width: 0; padding: 15px; }
    .pdv-left .flex-row-mobile { flex-direction: column; align-items: stretch; gap: 10px; }
    .pdv-left #qtdVenda { width: 100%; }
    .carrinho-table { min-width: 100%; font-size: 13px; }
    .carrinho-table th, .carrinho-table td { padding: 10px 5px; white-space: nowrap; }
    td { white-space: nowrap; } 
    .total-carrinho { font-size: 26px; }
    .filtros-relatorio { flex-direction: column; align-items: stretch !important; gap: 15px; }
    #modalCatalogo .flex button { padding: 18px; font-size: 16px; }
}

#loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--secondary); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;}
#loginOverlay .card { padding: 40px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; max-width: 380px; text-align: center; }

#modalRecibo { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.7); z-index: 3000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(3px); }
#modalRecibo .card { width: 100%; max-width: 320px; text-align: center; border-radius: 16px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); margin:0 auto;}

#modalAcoesCatalogo { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(15, 23, 42, 0.7); z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(3px); }
#modalAcoesCatalogo .card { width: 100%; max-width: 350px; text-align: center; border-radius: 16px; padding: 25px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); margin:0 auto; }

#reciboImpressao { position: absolute; top: -9999px; z-index: -1000; opacity: 0; pointer-events: none; }

/* Impress√£o apenas para recibos. O Cat√°logo agora gera nativo via jsPDF */
@media print {
    body { display: block !important; margin: 0 !important; padding: 0 !important; background: #fff !important; height: auto !important; min-height: auto !important; overflow: visible !important; }
    .sidebar, .main-content, #loginOverlay, #modalRecibo, #modalAcoesCatalogo, #modalCatalogo { display: none !important; }
    
    body.print-recibo #reciboImpressao { display: block !important; position: relative !important; top: 0 !important; left: 0 !important; opacity: 1 !important; z-index: 1000 !important; width: 80mm !important; max-width: 100% !important; font-family: 'Courier New', Courier, monospace; font-size: 12px; color: #000; margin: 0; padding: 0 10px; }
    body:not(.print-recibo) #reciboImpressao { display: none !important; }
    
    .recibo-header { text-align: center; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-top: 10px;}
    .recibo-header h2 { margin: 0 0 5px 0; font-size: 22px; text-transform: uppercase; font-weight: 900; letter-spacing: 1px;}
    .recibo-header p { margin: 2px 0; font-size: 11px; }
    .recibo-info { margin-bottom: 10px; font-size: 11px; }
    .recibo-info p { margin: 3px 0; }
    .recibo-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; border-bottom: 1px dashed #000; padding-bottom: 5px; }
    .recibo-table th, .recibo-table td { text-align: left; padding: 5px 0; font-size: 11px; vertical-align: top; }
    .recibo-table th { border-bottom: 1px dashed #000; font-weight: bold; }
    .recibo-table .right { text-align: right; }
    .recibo-totais { margin-bottom: 10px; font-size: 12px; width: 100%; }
    .recibo-totais .linha { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .recibo-totais .destaque { font-size: 14px; font-weight: bold; margin-top: 6px; border-top: 1px solid #000; padding-top: 6px; }
    .recibo-footer { text-align: center; font-size: 10px; margin-top: 15px; border-top: 1px dashed #000; padding-top: 10px; margin-bottom: 20px;}
    .recibo-footer p { margin: 3px 0; line-height: 1.4;}
}
</style>
</head>
<body>

<div id="reciboImpressao"></div>

<div id="loginOverlay">
    <div class="card">
        <img src="logo-lakami.jpg" alt="Lakami Kids" style="max-width: 160px; margin-bottom: 10px; border-radius: 12px;">
        <h3 style="color: var(--text-side); margin-top: 0; font-weight: 700;">Acesso ao Sistema</h3>
        <input type="text" id="user" placeholder="Usu√°rio">
        <input type="password" id="pass" placeholder="Senha">
        <button id="btnLogin" onclick="login()" style="padding: 15px; font-size: 16px; margin-top: 10px;">Entrar na Loja</button>
        <p id="loginMsg" style="text-align:center; font-size:12px; color: #10b981; margin-top:10px; font-weight:700;"></p>
    </div>
</div>

<div id="modalRecibo" class="hidden">
    <div class="card">
        <h3 style="margin-top:0; color:var(--text-side);">Emitir Recibo</h3>
        <p style="font-size:13px; color:#64748b; margin-bottom:20px;">Como deseja enviar o comprovante para o cliente?</p>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="dispararReciboWhatsApp()" class="whatsapp" style="padding:14px; display:flex; justify-content:center; align-items:center; gap:8px;">
                <span style="font-size:18px;">üì≤</span> Enviar por WhatsApp
            </button>
            <button onclick="dispararReciboPapel()" style="background:#0284c7; padding:14px; display:flex; justify-content:center; align-items:center; gap:8px;">
                <span style="font-size:18px;">üñ®Ô∏è</span> Imprimir na M√°quina
            </button>
            <button onclick="fecharModalRecibo()" style="background:#94a3b8; padding:14px; margin-top:10px;">Cancelar</button>
        </div>
    </div>
</div>

<div id="modalAcoesCatalogo" class="hidden">
    <div class="card">
        <h3 style="margin-top:0; color:var(--text-side);">Partilhar Vitrine</h3>
        <p style="font-size:13px; color:#64748b; margin-bottom:15px;">Como deseja enviar os produtos selecionados?</p>

        <div style="text-align:left; margin-bottom:15px;">
            <label style="font-size:12px; font-weight:700; color:#475569; display:block; margin-bottom:5px;">1. Selecione o Cliente (Opcional)</label>
            <select id="selectClienteCatalogo" style="width:100%; margin:0;">
                <option value="">Nenhum (Escolher no WhatsApp)</option>
            </select>
        </div>

        <div style="text-align:left; margin-bottom:10px;">
            <label style="font-size:12px; font-weight:700; color:#475569; display:block;">2. Escolha o formato de envio</label>
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="enviarCatalogoWhatsApp()" class="whatsapp" style="padding:14px; display:flex; justify-content:center; align-items:center; gap:8px;">
                <span style="font-size:18px;">üì≤</span> Enviar Lista p/ WhatsApp
            </button>
            <button onclick="imprimirCatalogoVisualEFechar()" style="background:#0284c7; padding:14px; display:flex; justify-content:center; align-items:center; gap:8px;">
                <span style="font-size:18px;">üñ®Ô∏è</span> Baixar PDF NATIVO
            </button>
            <button onclick="copiarCatalogoTextoDaModal()" style="background:#f1f5f9; color:#475569; padding:12px; border:1px solid #cbd5e1; font-size:13px;">
                üìã Apenas Copiar Texto
            </button>
            <button onclick="fecharModalAcoesCatalogo()" style="background:#ef4444; padding:12px; margin-top:5px;">Cancelar</button>
        </div>
    </div>
</div>

<div id="modalCatalogo" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:4000; overflow-y:auto; padding:20px;">
    <div style="max-width:900px; margin:0 auto; background:#fff; padding:25px; border-radius:15px; box-shadow:0 10px 25px rgba(0,0,0,0.1);">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #f1f5f9; padding-bottom:15px; margin-bottom:20px;">
            <div>
                <h2 style="margin:0; color:var(--primary);">Vitrine LAKAMI KIDS</h2>
                <p style="margin:5px 0 0 0; font-size:14px; color:#64748b;">Selecione as pe√ßas que deseja incluir no cat√°logo de envio.</p>
            </div>
            <button onclick="fecharCatalogo()" class="danger btn-acao-x" style="font-size:16px;">X</button>
        </div>
        
        <div style="display:flex; gap:10px; margin-bottom:15px; flex-wrap:wrap;">
            <button onclick="selecionarTodosCatalogo()" style="background:#475569; padding:10px 15px; font-size:12px; margin:0; width:auto;">‚òëÔ∏è Selecionar Todos</button>
            <button onclick="limparSelecaoCatalogo()" style="background:#94a3b8; padding:10px 15px; font-size:12px; margin:0; width:auto;">‚òê Limpar Sele√ß√£o</button>
        </div>

        <div class="flex" style="gap:10px; margin-bottom:25px; border-bottom:1px solid #e2e8f0; padding-bottom:20px;">
            <button onclick="abrirModalAcoesCatalogo()" style="background:var(--primary); padding:14px 20px; font-size:15px; flex:1; width:100%;">
                <span style="font-size:18px; margin-right:8px;">üì§</span> Partilhar Vitrine Selecionada
            </button>
        </div>

        <div id="gridCatalogo" style="display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:20px;">
            </div>
    </div>
</div>

<div class="sidebar">
    <div class="sidebar-header"><img src="logo-lakami.jpg" alt="Lakami Kids"></div>
    <div class="nav-menu">
        <div class="nav-item active" onclick="showSection('sec-resumo', this)" title="Resumo">üìä <span>Resumo Financeiro</span></div>
        <div class="nav-item" onclick="showSection('sec-pdv', this)" title="PDV">üõí <span>PDV / Nova Venda</span></div>
        <div class="nav-item" onclick="showSection('sec-produtos', this)" title="Produtos">üì¶ <span>Gest√£o de Produtos</span></div>
        <div class="nav-item" onclick="showSection('sec-vendas', this)" title="Vendas">üìù <span>Hist√≥rico de Vendas</span></div>
        <div class="nav-item" onclick="showSection('sec-clientes', this)" title="Clientes">üë• <span>Clientes (CRM)</span></div>
        <div class="nav-item" onclick="showSection('sec-fornecedores', this)" title="Fornecedores">ü§ù <span>Fornecedores</span></div>
        <div class="nav-item" onclick="showSection('sec-compras', this)" title="Compras">üöö <span>Compras / Estoque</span></div>
        <div class="nav-item" onclick="showSection('sec-despesas', this)" title="Despesas">üí∏ <span>Despesas da Loja</span></div>
        <div class="nav-item" onclick="showSection('sec-backup', this)" title="Relat√≥rios">üíæ <span>Relat√≥rios / Exporta√ß√£o</span></div>
        
        <div style="flex-grow: 1;"></div>
        <div style="margin-top: 15px; border-top: 1px solid #e2e8f0; padding-top: 10px;"></div>
        <div class="nav-item" onclick="logout()" style="color: #ef4444; font-weight: 700;" title="Sair">üö™ <span>Sair do Sistema</span></div>
    </div>
</div>

<div class="main-content">
    
    <div id="sec-resumo" class="section active">
        <div class="card">
            <div id="painelAniversarios" style="display:none; background:#fef08a; padding:15px; border-radius:8px; margin-bottom:20px; color:#854d0e; font-size:14px; border:1px solid #fde047; box-shadow: 0 2px 4px rgba(0,0,0,0.05);"></div>

            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom: 15px;">
                <h3 style="margin:0">Dashboard Geral</h3>
                <select id="filtroDataDash" onchange="atualizar()" style="width:auto; min-width:160px; margin:0; font-weight:600; color:var(--primary); background:#fdf2f8; border:1px solid #fbcfe8; cursor:pointer;">
                    <option value="Tudo">Todo o Per√≠odo</option>
                    <option value="Hoje">Hoje</option>
                    <option value="Esta Semana">Esta Semana</option>
                    <option value="Este M√™s">Este M√™s</option>
                    <option value="M√™s Passado">M√™s Passado</option>
                </select>
            </div>
            <div class="grid">
                <div class="box" id="saldoConta">Saldo em Conta<span>R$ 0,00</span></div>
                <div class="box" id="qtdEstoque">Pe√ßas no Estoque<span>0</span></div>
                <div class="box" id="qtdVendidas">Pe√ßas Vendidas<span>0</span></div>
                <div class="box" id="investimento">Custo Estoque<span>R$ 0,00</span></div>
                <div class="box" id="valorEstoque">Venda Projetada<span>R$ 0,00</span></div>
                <div class="box" id="receitas">Vendas Recebidas<span>R$ 0,00</span></div>
                <div class="box" id="vendasAReceber">A Receber (Fiado)<span>R$ 0,00</span></div>
                <div class="box" id="despesas">Despesas<span>R$ 0,00</span></div>
                <div class="box" id="lucro">Lucro L√≠quido<span>0%</span></div>
                <div class="box" id="margem">Margem Global<span>0%</span></div>
            </div>
        </div>
    </div>

    <div id="sec-pdv" class="section">
        <div class="card">
            <h3>Ponto de Venda (PDV)</h3>
            <div class="pdv-container">
                <div class="pdv-left">
                    <div style="display:flex; flex-direction:column; gap:10px; width:100%;">
                        <div class="flex flex-row-mobile" style="align-items:center;">
                            <div class="custom-select" id="pdvSelectBox" style="width:100%;">
                                <div class="select-selected" id="pdvSelectDisplay" onclick="togglePDVDropdown()">
                                    <span>Selecione o Produto (Modelo)...</span>
                                    <span style="color:#999; font-size:12px">‚ñº</span>
                                </div>
                                <div class="select-items hidden" id="pdvSelectList"></div>
                                <input type="hidden" id="selectProd" value="">
                                <input type="hidden" id="selectProdTam" value="">
                            </div>
                            <div style="display:flex; gap:10px; width:100%;">
                                <input id="qtdVenda" type="number" value="1" style="flex:1; text-align: center; margin:0;" title="Quantidade">
                                <button class="btn-inserir" onclick="addCarrinho()" style="flex:2; margin:0; padding: 14px 12px;">Inserir</button>
                            </div>
                        </div>
                        <div id="boxTamanhosPDV" style="display:none; background:#fff; padding:15px; border-radius:8px; border:2px dashed #cbd5e1;"></div>
                    </div>
                    <div class="table-wrapper" style="margin-top:20px;">
                        <table class="carrinho-table"><thead><tr><th>Produto & Tamanho</th><th>Qtd</th><th>Subtotal</th><th>X</th></tr></thead><tbody id="carrinho"></tbody></table>
                    </div>
                </div>
                
                <div class="pdv-right">
                    <div class="total-carrinho" id="totalCarrinho">R$ 0,00</div>
                    <select id="selectCliente" onchange="selecionarClientePDV()"><option value="">Cliente Padr√£o (Avulso)</option></select>
                    
                    <div id="boxCreditoCliente" style="display:none; flex-direction:column; gap:5px; background:#dcfce7; padding:10px; border-radius:8px; border:1px solid #bbf7d0;">
                        <label style="font-size:12px; font-weight:700; color:#166534;">Cr√©dito em Loja: <span id="infoCreditoCliente">R$ 0,00</span></label>
                        <div class="flex" style="gap:5px; margin-top:5px;">
                            <input type="number" id="usarCreditoCli" value="0" step="0.01" max="0" oninput="atualizarCarrinho()" style="margin:0; flex:1;" title="Valor a usar">
                            <button onclick="aplicarCreditoMaximo()" style="margin:0; background:#166534; font-size:12px; padding:12px;">Usar Tudo</button>
                        </div>
                    </div>

                    <select id="formaPag" onchange="tratarRegrasPagamento()">
                        <option value="PIX">PIX</option>
                        <option value="√Ä vista (Dinheiro)">√Ä vista (Dinheiro)</option>
                        <option value="Cart√£o de Cr√©dito">Cart√£o de Cr√©dito</option>
                        <option value="Cart√£o de D√©bito">Cart√£o de D√©bito</option>
                        <option value="Prazo">A Prazo / Fiado</option>
                    </select>
                    <div id="boxDesconto" style="display:none; flex-direction:column; gap:5px"><label style="font-size:12px; font-weight:700; color:var(--primary)">Desconto B√¥nus (%)</label><input type="number" id="valorDesconto" value="0" oninput="atualizarCarrinho()"></div>
                    <input type="date" id="dataPrazo" class="hidden" title="Data de Vencimento do Fiado">
                    <button id="btnFinalizarVenda" onclick="finalizarVenda()" class="success" style="padding:15px; font-size:16px; margin-top:15px">FINALIZAR VENDA</button>
                </div>
            </div>
        </div>
    </div>

    <div id="sec-produtos" class="section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px; margin-bottom:15px;">
                <h3 style="margin:0;">Gest√£o de Estoque e Grade</h3>
                <button onclick="abrirCatalogo()" style="width:auto; margin:0; padding:12px 20px; background:var(--secondary); font-size:13px;">üëÅÔ∏è Ver Cat√°logo Digital</button>
            </div>
            
            <div style="background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; display:flex; flex-direction:column; gap:15px;">
                <div class="flex" style="align-items: center;">
                    <div class="produto-img-box" style="margin-right:10px;">
                        <img id="previewImg" class="produto-img-preview" src="https://via.placeholder.com/120?text=Foto">
                        <input type="file" id="imgProdFile" accept="image/*" style="display:none;" onchange="previewImage(event)">
                        <button onclick="document.getElementById('imgProdFile').click()" style="background:#475569; padding:10px; font-size:12px; margin:0;">üì∑ Add Foto</button>
                    </div>
                    <div style="flex: 1; display:flex; flex-direction:column; gap:10px; width:100%;">
                        <input id="nomeProd" placeholder="Nome do Modelo (Ex: Vestido Floral)" style="margin:0;">
                        <div class="flex" style="gap:10px; width:100%;">
                            <input id="compraProd" type="number" step="0.01" placeholder="Custo R$" style="margin:0; flex:1;">
                            <input id="vendaProd" type="number" step="0.01" placeholder="Venda R$" style="margin:0; flex:1;">
                        </div>
                    </div>
                </div>
                <div style="background:#fff; border:1px solid #cbd5e1; border-radius:8px; padding:15px;">
                    <div style="font-size:13px; font-weight:700; color:var(--primary); margin-bottom:12px;">Grade de Estoque (Apenas nos tamanhos que possui):</div>
                    <div id="gradeTamanhosUI" class="grade-grid"></div>
                </div>
                <button id="btnSalvarProd" onclick="addProduto()" style="padding:15px; font-size:15px; margin:0;">Salvar Grade de Produto</button>
            </div>
            <div class="table-wrapper" style="margin-top:20px;">
                <table><thead><tr><th>Foto</th><th>Modelo</th><th>Grade em Estoque</th><th>Total Pe√ßas</th><th>Custo</th><th>Venda</th><th>A√ß√µes</th></tr></thead><tbody id="listaProd"></tbody></table>
            </div>
        </div>
    </div>

    <div id="sec-vendas" class="section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:10px;">
                <h3 style="margin:0;">Hist√≥rico de Vendas (Trocas e Devolu√ß√µes)</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input type="date" id="dataFechamentoCaixa" style="margin:0; padding:10px; font-size:13px; border-radius:6px; border:1px solid #cbd5e1; height: 38px;">
                    <button onclick="fechamentoCaixa()" style="background:#475569; width:auto; padding:0 15px; height:38px; font-size:13px; margin:0;">üìä Fechar Caixa</button>
                </div>
            </div>
            <div class="table-wrapper" style="margin-top:15px;">
                <table><thead><tr><th>Data</th><th>Produto & Tam</th><th>Cliente</th><th>Total</th><th>D√≠vida</th><th>Lucro Item</th><th>Situa√ß√£o</th><th>A√ß√µes</th></tr></thead><tbody id="listaVendas"></tbody></table>
            </div>
        </div>
    </div>

    <div id="sec-clientes" class="section">
        <div class="card">
            <h3>Clientes da Loja (CRM)</h3>
            <div class="flex">
                <input id="clienteNome" placeholder="Nome do Cliente">
                <input id="clienteTel" placeholder="WhatsApp (Apenas N√∫meros)">
                <input type="date" id="clienteNasc" title="Data de Nascimento da Crian√ßa">
                <button id="btnSalvarCli" onclick="addCliente()">Salvar Cliente</button>
            </div>
            <div class="table-wrapper"><table><thead><tr><th>Nome</th><th>WhatsApp</th><th>Nascimento</th><th>Vale-Cr√©dito</th><th>A√ß√µes</th></tr></thead><tbody id="listaClientes"></tbody></table></div>
        </div>
    </div>

    <div id="sec-fornecedores" class="section">
        <div class="card">
            <h3>Fornecedores Parceiros</h3>
            <div class="flex"><input id="fornNome" placeholder="Nome da Empresa"><input id="fornContato" placeholder="Contato"><button id="btnSalvarForn" onclick="addFornecedor()">Salvar Fornecedor</button></div>
            <div class="table-wrapper"><table><thead><tr><th>Nome</th><th>Contato</th><th>A√ß√µes</th></tr></thead><tbody id="listaFornecedores"></tbody></table></div>
        </div>
    </div>

    <div id="sec-compras" class="section">
        <div class="card">
            <h3>Entrada de Mercadorias (Hist√≥rico)</h3>
            <div class="flex">
                <input type="date" id="dataNovaCompra"><input id="empresaCompra" placeholder="Fornecedor">
                <input type="number" id="valorCompra" step="0.01" placeholder="Valor Produtos"><input type="number" id="qtdPecasCompra" placeholder="Qtd Total">
                <input type="number" id="freteCompra" step="0.01" placeholder="Frete R$"><select id="pagCompra"><option value="PIX">PIX</option><option value="Cart√£o">Cart√£o</option></select>
                <button id="btnSalvarCompra" onclick="addHistoricoCompra()">Registrar Compra</button>
            </div>
            <div class="table-wrapper"><table><thead><tr><th>Data</th><th>Fornecedor</th><th>Pe√ßas</th><th>Valor</th><th>Frete</th><th>Total Nota</th><th>Pagamento</th><th>A√ß√µes</th></tr></thead><tbody id="listaHistoricoCompras"></tbody></table></div>
        </div>
    </div>

    <div id="sec-despesas" class="section">
        <div class="card">
            <h3>Despesas Operacionais</h3>
            <div class="flex"><input id="descDespesa" placeholder="Ex: Energia, Aluguel, Sacolas"><input id="valorDespesa" type="number" step="0.01" placeholder="Valor R$"><button id="btnSalvarDespesa" onclick="addDespesa()">Salvar Despesa</button></div>
            <div class="table-wrapper"><table><thead><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th><th>A√ß√µes</th></tr></thead><tbody id="listaDespesas"></tbody></table></div>
        </div>
    </div>

    <div id="sec-backup" class="section">
        <div class="card">
            <h3>Relat√≥rios Profissionais e Exporta√ß√£o</h3>
            <p style="color:#64748b; font-size:14px;">Gere relat√≥rios detalhados para o seu controle financeiro e estrat√©gico.</p>
            
            <div style="background:#f8fafc; padding:20px; border-radius:12px; border:1px solid #e2e8f0; margin-bottom:20px;">
                <div class="flex filtros-relatorio" style="align-items:flex-end;">
                    <div style="flex:2; min-width:200px;">
                        <label style="font-size:12px; font-weight:700; color:#475569;">Tipo de Relat√≥rio</label>
                        <select id="tipoRelatorio" style="margin-top:5px; margin-bottom:0;">
                            <option value="vendas">Hist√≥rico de Vendas Geral</option>
                            <option value="fiados">Inadimpl√™ncia (Fiados a Receber)</option>
                            <option value="produtos">Invent√°rio de Estoque (Produtos)</option>
                            <option value="despesas">Resumo de Despesas Operacionais</option>
                        </select>
                    </div>
                    <div style="flex:1; min-width:130px;">
                        <label style="font-size:12px; font-weight:700; color:#475569;">Data Inicial (Opcional)</label>
                        <input type="date" id="dataIniRel" style="margin-top:5px; margin-bottom:0;">
                    </div>
                    <div style="flex:1; min-width:130px;">
                        <label style="font-size:12px; font-weight:700; color:#475569;">Data Final (Opcional)</label>
                        <input type="date" id="dataFimRel" style="margin-top:5px; margin-bottom:0;">
                    </div>
                </div>
            </div>

            <div class="grid">
                <button onclick="gerarRelatorio('excel')" style="background:#166534; padding:20px; font-size:15px;">üìó Baixar Planilha (Excel/CSV)</button>
                <button onclick="gerarRelatorio('pdf')" style="background:#991b1b; padding:20px; font-size:15px;">üìï Gerar Documento (PDF)</button>
            </div>
        </div>
    </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHwt8eGsCv2dnKAYQa0iaqWoHyGxl5V14",
  authDomain: "lakami-pro.firebaseapp.com",
  projectId: "lakami-pro",
  storageBucket: "lakami-pro.firebasestorage.app",
  messagingSenderId: "966421239270",
  appId: "1:966421239270:web:60d9b7c79ba700c515f227"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const formatCurrency = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
const el = (id) => document.getElementById(id);

const tamanhosPadrao = ['√önico','RN','P','M','G','GG','1','2','3','4','6','8','10','12','14','16'];

window.showSection = function(id, element) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    el(id).classList.add('active'); element.classList.add('active');
};

let produtos = [], clientes = [], fornecedores = [], vendas = [], despesas = [], historicoCompras = [], carrinhoArr = [];
let editProdId=null, editCliId=null, editFornId=null;
let currentImgBase64 = "";
let idVendaAtualRecibo = null; 
let produtosSelecionadosCatalogo = new Set();

async function puxarDadosNuvem() {
    const fetchCol = async (n) => { const snap = await getDocs(collection(db, n)); return snap.docs.map(d => d.data()); };
    const results = await Promise.all([
        fetchCol("produtos"), fetchCol("clientes"), fetchCol("fornecedores"),
        fetchCol("vendas"), fetchCol("despesas"), fetchCol("historicoCompras")
    ]);
    produtos = results[0]; clientes = results[1]; fornecedores = results[2];
    vendas = results[3]; despesas = results[4]; historicoCompras = results[5];
}

async function salvarFirebase(col, item) { await setDoc(doc(db, col, item.id.toString()), item); }
async function deletarFirebase(col, id) { await deleteDoc(doc(db, col, id.toString())); }

function renderGradeUI() {
    let html = '';
    tamanhosPadrao.forEach(t => {
        html += `<div style="display:flex; flex-direction:column; align-items:center;">
            <label style="font-size:12px; font-weight:700; color:#475569; margin-bottom:5px;">${t}</label>
            <input type="number" id="grade_${t}" style="padding:10px 5px; text-align:center; margin:0; width:100%; border:1px solid #cbd5e1; border-radius:6px; background:#f8fafc;" min="0" placeholder="-">
        </div>`;
    });
    el("gradeTamanhosUI").innerHTML = html;
}

window.login = async function(){
    if(el("user").value==="admin" && el("pass").value==="1234"){ 
        el("btnLogin").disabled = true; 
        el("loginMsg").style.color = "#f59e0b";
        el("loginMsg").innerText = "A sincronizar dados da nuvem. Por favor aguarde...";
        
        try {
            await puxarDadosNuvem(); 
            el("loginOverlay").classList.add("hidden"); 
            el("dataNovaCompra").valueAsDate = new Date(); 
            el("dataFechamentoCaixa").value = new Date().toISOString().split('T')[0];
            renderGradeUI();
            atualizar(); 
        } catch(e) {
            el("loginMsg").style.color = "#ef4444";
            el("loginMsg").innerText = "Falha de liga√ß√£o √† internet. Tente novamente.";
            el("btnLogin").disabled = false;
        }
    } else alert("Acesso Negado.");
};

window.logout = function() {
    if(confirm("Tem certeza que deseja sair e bloquear o sistema?")) window.location.reload();
};

document.addEventListener("click", function(e){
    let box = el("pdvSelectBox");
    if(box && !box.contains(e.target)){
        let list = el("pdvSelectList");
        if(list) list.classList.add("hidden");
    }
});

window.togglePDVDropdown = function() { el("pdvSelectList").classList.toggle('hidden'); };

window.selecionarProdutoPDV = function(id, nome, img) {
    el("selectProd").value = id; el("selectProdTam").value = ""; 
    let imgHtml = img ? `<img src="${img}" style="width:30px;height:30px;border-radius:4px;object-fit:cover;">` : `<div style="width:30px;height:30px;background:#e2e8f0;border-radius:4px;"></div>`;
    el("pdvSelectDisplay").innerHTML = `<div style="display:flex;align-items:center;gap:10px;">${imgHtml} <b style="font-size:14px;">${nome}</b></div><span style="color:#999; font-size:12px">‚ñº</span>`;
    el("pdvSelectList").classList.add("hidden");

    let p = produtos.find(x => x.id == id);
    let gradeObj = p.grade || { [p.tam || '√önico']: p.qtd };
    let htmlBotoes = '<div style="font-size:12px; font-weight:700; color:#475569; margin-bottom:8px;">2. Selecione o Tamanho Dispon√≠vel:</div><div style="display:flex; gap:8px; flex-wrap:wrap;">';
    let temEstoque = false;
    
    Object.keys(gradeObj).forEach(t => {
        if(gradeObj[t] > 0) {
            temEstoque = true;
            htmlBotoes += `<button type="button" class="btn-tamanho" onclick="escolherTamanhoPDV(this, '${t}')">${t} <br><span style="font-size:10px; font-weight:normal; opacity:0.8;">${gradeObj[t]} unid</span></button>`;
        }
    });
    if(!temEstoque) htmlBotoes += '<span style="color:#ef4444; font-weight:bold; font-size:13px;">Produto totalmente Esgotado!</span>';
    htmlBotoes += '</div>';
    el("boxTamanhosPDV").innerHTML = htmlBotoes; el("boxTamanhosPDV").style.display = "block";
};

window.escolherTamanhoPDV = function(btn, tam) {
    document.querySelectorAll('.btn-tamanho').forEach(b => b.classList.remove('ativo'));
    btn.classList.add('ativo'); el("selectProdTam").value = tam;
};

window.previewImage = function(event) {
    let file = event.target.files[0]; if(!file) return;
    let reader = new FileReader();
    reader.onload = function(e) { currentImgBase64 = e.target.result; el('previewImg').src = currentImgBase64; };
    reader.readAsDataURL(file);
};
window.uploadFotoDireta = function(event, id) {
    let file = event.target.files[0]; if(!file) return;
    let reader = new FileReader();
    reader.onload = async function(e) { 
        let p = produtos.find(x => x.id == id); 
        if(p){ 
            try {
                p.img = e.target.result; 
                await salvarFirebase("produtos", p); 
                atualizar(); 
            } catch(err) { alert("Erro ao carregar fotografia."); }
        } 
    };
    reader.readAsDataURL(file);
};

window.addProduto = async function(){
    const n = el("nomeProd").value.trim(); const c = parseFloat(el("compraProd").value); const v = parseFloat(el("vendaProd").value);
    if(!n || isNaN(c) || isNaN(v)) return alert("Preencha Nome, Custo e Venda.");
    let gradeObj = {}; let totalQtd = 0;
    tamanhosPadrao.forEach(t => { let val = parseInt(el("grade_"+t).value); if(!isNaN(val) && val > 0) { gradeObj[t] = val; totalQtd += val; } });
    if(totalQtd === 0) return alert("Adicione estoque em pelo menos um tamanho da grade.");

    el("btnSalvarProd").disabled = true; el("btnSalvarProd").innerText = "A Guardar na Nuvem...";

    let obj = editProdId ? produtos.find(x => x.id == editProdId) : {id: Date.now()};
    obj.nome = n; obj.compra = c; obj.venda = v; obj.grade = gradeObj; obj.qtd = totalQtd; obj.tam = "Grade"; 
    if(currentImgBase64 !== "") obj.img = currentImgBase64; 
    
    try {
        await salvarFirebase("produtos", obj);
        if(!editProdId) produtos.push(obj);
        editProdId=null; 
        currentImgBase64=""; el('previewImg').src="https://via.placeholder.com/120?text=Foto";
        el("nomeProd").value=""; el("compraProd").value=""; el("vendaProd").value="";
        tamanhosPadrao.forEach(t => el("grade_"+t).value = ""); 
        atualizar();
    } catch(err) {
        alert("Erro na conex√£o ao gravar produto. Verifique a internet.");
    } finally {
        el("btnSalvarProd").disabled = false; el("btnSalvarProd").innerText = "Salvar Grade de Produto";
    }
};

window.editarProduto = function(id) {
    let p = produtos.find(x => x.id == id);
    el("nomeProd").value = p.nome; el("compraProd").value = p.compra; el("vendaProd").value = p.venda;
    currentImgBase64 = p.img || ""; el('previewImg').src = p.img || "https://via.placeholder.com/120?text=Foto";
    tamanhosPadrao.forEach(t => el("grade_"+t).value = "");
    let g = p.grade || { [p.tam || '√önico']: p.qtd };
    Object.keys(g).forEach(t => { if(el("grade_"+t)) el("grade_"+t).value = g[t]; });
    editProdId = id; el("btnSalvarProd").innerText="Atualizar Grade de Produto";
    showSection('sec-produtos', document.querySelectorAll('.nav-item')[2]);
};

window.excluirProduto = async function(id){ 
    if(confirm("Tem certeza que deseja excluir o produto inteiro?")){ 
        try {
            await deletarFirebase("produtos", id);
            produtos=produtos.filter(x=>x.id!=id); atualizar(); 
        } catch(e) { alert("Erro ao excluir da nuvem."); }
    } 
};

window.addCliente = async function(){ 
    const n = el("clienteNome").value.trim(); if(!n) return alert("Preencha o nome do cliente."); 
    el("btnSalvarCli").disabled = true; el("btnSalvarCli").innerText = "A aguardar...";
    let obj = editCliId ? clientes.find(x=>x.id==editCliId) : {id: Date.now(), credito: 0}; 
    obj.nome=n; obj.tel=el("clienteTel").value; obj.nasc=el("clienteNasc").value;
    try {
        await salvarFirebase("clientes", obj);
        if(!editCliId) clientes.push(obj); editCliId=null; 
        el("clienteNome").value=""; el("clienteTel").value=""; el("clienteNasc").value=""; atualizar(); 
    } catch(e) { alert("Erro de rede ao salvar cliente."); }
    finally { el("btnSalvarCli").disabled = false; el("btnSalvarCli").innerText = "Salvar Cliente"; }
};

window.editarCliente = function(id){ 
    let c = clientes.find(x=>x.id==id); el("clienteNome").value=c.nome; el("clienteTel").value=c.tel; el("clienteNasc").value=c.nasc||""; 
    editCliId=id; el("btnSalvarCli").innerText="Atualizar Cliente"; 
    showSection('sec-clientes', document.querySelectorAll('.nav-item')[4]); 
};
window.excluirCliente = async function(id){ 
    if(confirm("Tem certeza que deseja excluir este cliente?")){ 
        try { await deletarFirebase("clientes", id); clientes=clientes.filter(x=>x.id!=id); atualizar(); }
        catch(e) { alert("Erro de exclus√£o."); }
    } 
};

window.selecionarClientePDV = function() {
    let cNome = el("selectCliente").value;
    let c = clientes.find(x => x.nome === cNome);
    let boxCredito = el("boxCreditoCliente");
    let inputCredito = el("usarCreditoCli");
    if(c && c.credito > 0) {
        boxCredito.style.display = "flex";
        el("infoCreditoCliente").innerText = formatCurrency(c.credito);
        inputCredito.max = c.credito; inputCredito.value = 0;
    } else {
        boxCredito.style.display = "none"; inputCredito.value = 0; inputCredito.max = 0;
    }
    atualizarCarrinho();
};
window.aplicarCreditoMaximo = function() {
    let cNome = el("selectCliente").value;
    let c = clientes.find(x => x.nome === cNome);
    if(c && c.credito > 0) { el("usarCreditoCli").value = c.credito; atualizarCarrinho(); }
};

window.addFornecedor = async function(){ 
    const n = el("fornNome").value.trim(); if(!n) return alert("Preencha a empresa."); 
    el("btnSalvarForn").disabled = true;
    let obj = editFornId ? fornecedores.find(x=>x.id==editFornId) : {id: Date.now()}; obj.nome=n; obj.contato=el("fornContato").value; 
    try {
        await salvarFirebase("fornecedores", obj);
        if(!editFornId) fornecedores.push(obj); editFornId=null; 
        el("fornNome").value=""; el("fornContato").value=""; atualizar(); 
    } catch(e) { alert("Erro de rede."); }
    finally { el("btnSalvarForn").disabled = false; el("btnSalvarForn").innerText = "Salvar Fornecedor"; }
};
window.editarFornecedor = function(id){ 
    let f = fornecedores.find(x=>x.id==id); el("fornNome").value=f.nome; el("fornContato").value=f.contato; 
    editFornId=id; el("btnSalvarForn").innerText="Atualizar Fornecedor"; 
    showSection('sec-fornecedores', document.querySelectorAll('.nav-item')[5]); 
};
window.excluirFornecedor = async function(id){ 
    if(confirm("Deseja excluir?")){ try{ await deletarFirebase("fornecedores", id); fornecedores=fornecedores.filter(x=>x.id!=id); atualizar(); } catch(e){}} 
};

window.addHistoricoCompra = async function(){ 
    const data = el("dataNovaCompra").value; const empresa = el("empresaCompra").value.trim(); const valor = parseFloat(el("valorCompra").value); const qtd = parseInt(el("qtdPecasCompra").value); const frete = parseFloat(el("freteCompra").value) || 0; const pagamento = el("pagCompra").value; 
    if(!data || !empresa || isNaN(valor) || isNaN(qtd)) return alert("Preencha todos os dados."); 
    el("btnSalvarCompra").disabled = true;
    let obj = {id: Date.now(), data, empresa, valor, qtd, frete, pagamento}; 
    try {
        await salvarFirebase("historicoCompras", obj);
        historicoCompras.push(obj); el("empresaCompra").value=""; el("valorCompra").value=""; el("qtdPecasCompra").value=""; el("freteCompra").value=""; atualizar(); 
    } catch(e){ alert("Erro de rede."); } finally { el("btnSalvarCompra").disabled = false; }
};
window.excluirHistoricoCompra = async function(id){ 
    if(confirm("Excluir entrada?")){ try { await deletarFirebase("historicoCompras", id); historicoCompras=historicoCompras.filter(x=>x.id!=id); atualizar(); } catch(e){}} 
};

window.addDespesa = async function(){ 
    const desc = el("descDespesa").value.trim(); const valor = parseFloat(el("valorDespesa").value); 
    if(!desc || isNaN(valor)) return alert("Preencha a descri√ß√£o e o valor."); 
    el("btnSalvarDespesa").disabled = true;
    let obj = {id: Date.now(), data: new Date().toISOString(), descricao: desc, valor: valor}; 
    try {
        await salvarFirebase("despesas", obj);
        despesas.push(obj); el("descDespesa").value=""; el("valorDespesa").value=""; atualizar(); 
    } catch(e) { alert("Erro."); } finally { el("btnSalvarDespesa").disabled = false; }
};
window.excluirDespesa = async function(id){ 
    if(confirm("Excluir despesa?")){ try { await deletarFirebase("despesas", id); despesas=despesas.filter(x=>x.id!=id); atualizar(); } catch(e){} } 
};

window.addCarrinho = function(){
    let pid = el("selectProd").value; let ptam = el("selectProdTam").value; 
    if(!pid) return alert("Por favor, selecione um produto primeiro.");
    if(!ptam) return alert("Por favor, clique no bot√£o com o TAMANHO desejado antes de inserir.");
    
    let p = produtos.find(x => x.id == pid); let q = parseInt(el("qtdVenda").value);
    let gradeObj = p.grade || { [p.tam || '√önico']: p.qtd };
    let estoqueDesseTamanho = gradeObj[ptam] || 0;

    if(q > estoqueDesseTamanho) return alert(`Aten√ß√£o: S√≥ existem ${estoqueDesseTamanho} pe√ßas do tamanho ${ptam} em estoque.`);
    
    carrinhoArr.push({id: p.id, tamanhoProduto: ptam, nome: p.nome, qtd: q, venda: p.venda, compra: p.compra});
    el("qtdVenda").value = "1"; el("selectProd").value = ""; el("selectProdTam").value = "";
    el("pdvSelectDisplay").innerHTML = '<span>Selecione o Produto (Modelo)...</span><span style="color:#999; font-size:12px">‚ñº</span>';
    el("boxTamanhosPDV").style.display = "none";
    window.atualizarCarrinho();
};

window.atualizarCarrinho = function(){
    let st = 0; let tb = el("carrinho"); tb.innerHTML = "";
    carrinhoArr.forEach((item, i) => {
        st += (item.qtd * item.venda);
        tb.innerHTML += `<tr>
            <td><div style="font-weight:700; color:#334155;">${item.nome}</div><div style="font-size:11px; color:var(--primary); font-weight:bold; margin-top:2px;">Tam: ${item.tamanhoProduto}</div></td>
            <td style="font-weight:bold;">${item.qtd}</td>
            <td>${formatCurrency(item.qtd*item.venda)}</td>
            <td><button class="danger" style="padding:10px; margin:0;" onclick="removerCarrinho(${i})">X</button></td>
        </tr>`;
    });
    
    let desc = parseFloat(el("valorDesconto").value) || 0;
    let creditoUsado = parseFloat(el("usarCreditoCli")?.value) || 0;
    
    let totalComDesconto = st * (1 - desc/100);
    let totalFinal = totalComDesconto - creditoUsado;
    if(totalFinal < 0) totalFinal = 0;

    el("totalCarrinho").innerText = "Total: " + formatCurrency(totalFinal);
};
window.removerCarrinho = (i) => { carrinhoArr.splice(i,1); window.atualizarCarrinho(); };

window.tratarRegrasPagamento = function(){
    let f = el("formaPag").value; let dp = el("dataPrazo"); let bd = el("boxDesconto");
    dp.className = f === "Prazo" ? "" : "hidden";
    bd.style.display = (f === "PIX" || f === "√Ä vista (Dinheiro)") ? "flex" : "none";
    if(bd.style.display === "none") el("valorDesconto").value = "0";
    window.atualizarCarrinho();
};

window.finalizarVenda = async function(){
    let f = el("formaPag").value; let desc = parseFloat(el("valorDesconto").value) || 0;
    let vencimento = el("dataPrazo").value; let creditoUsado = parseFloat(el("usarCreditoCli").value) || 0;
    let clienteNome = el("selectCliente").value || "Avulso";

    if(f === "Prazo" && !vencimento) return alert("Por favor, selecione a Data Prevista para Pagamento do Fiado.");
    if(!carrinhoArr.length) return alert("O carrinho est√° vazio.");

    el("btnFinalizarVenda").disabled = true; el("btnFinalizarVenda").innerText = "A Processar na Nuvem...";

    let promises = [];
    if(creditoUsado > 0) {
        let c = clientes.find(x => x.nome === clienteNome);
        if(c && c.credito >= creditoUsado) {
            c.credito -= creditoUsado;
            promises.push(salvarFirebase("clientes", c));
        } else { el("btnFinalizarVenda").disabled = false; return alert("Erro: Cr√©dito do cliente insuficiente."); }
    }

    let uid = Date.now();
    let subtotalGeral = carrinhoArr.reduce((acc, item) => acc + (item.venda * item.qtd * (1 - (desc/100))), 0);

    carrinhoArr.forEach(item => {
        let p = produtos.find(x => x.id == item.id); 
        if(p) { 
            if(!p.grade) p.grade = { [p.tam || '√önico']: p.qtd };
            p.grade[item.tamanhoProduto] -= item.qtd; p.qtd -= item.qtd; 
            promises.push(salvarFirebase("produtos", p)); 
        }
        
        let subtotalItem = (item.venda * item.qtd) * (1 - (desc/100));
        let propCredito = subtotalGeral > 0 ? (subtotalItem / subtotalGeral) * creditoUsado : 0;
        let totalFinalItem = subtotalItem - propCredito;

        let vObj = { 
            id: uid + Math.random(), data: new Date().toISOString(), produtoId: item.id, produto: item.nome, tamanhoProduto: item.tamanhoProduto,
            cliente: clienteNome, quantidade: item.qtd, total: totalFinalItem, custoHistorico: item.compra * item.qtd, 
            saldoDevedor: (f === "Prazo" ? totalFinalItem : 0), forma: f, creditoAbatido: propCredito, pagamentoPrevisto: vencimento || null, status: "Ativo", baixas: [] 
        };
        vendas.push(vObj); 
        promises.push(salvarFirebase("vendas", vObj));
    });
    
    try {
        await Promise.all(promises);
        carrinhoArr = []; el("valorDesconto").value="0"; el("dataPrazo").value=""; el("usarCreditoCli").value = 0;
        window.selecionarClientePDV(); window.atualizarCarrinho(); atualizar(); 
        alert("Venda Finalizada e Gravada com Sucesso!");
    } catch(e) { alert("Falha na internet ao finalizar venda. Tente de novo."); }
    finally { el("btnFinalizarVenda").disabled = false; el("btnFinalizarVenda").innerText = "FINALIZAR VENDA"; }
};

window.realizarTroca = async function(id) {
    let v = vendas.find(x => x.id == id);
    if(v.status === "Devolvido") return alert("Aten√ß√£o: Esta venda j√° foi devolvida e anulada do caixa.");

    let c = clientes.find(x => x.nome === v.cliente);
    let msg = `Tem certeza que deseja DEVOLVER: ${v.quantidade}x ${v.produto}? \nA pe√ßa voltar√° ao estoque.\n`;
    if(c) msg += `\nO valor de ${formatCurrency(v.total + (v.creditoAbatido||0))} ser√° depositado como VALE-CR√âDITO na conta da cliente.`;

    if(confirm(msg)) {
        let promises = [];
        let p = produtos.find(x => x.id == v.produtoId); 
        if(p){ 
            p.qtd += v.quantidade || 1; 
            let tDevolucao = v.tamanhoProduto || p.tam || '√önico';
            if(!p.grade) p.grade = { [p.tam || '√önico']: p.qtd - (v.quantidade||1) };
            p.grade[tDevolucao] = (p.grade[tDevolucao] || 0) + (v.quantidade || 1);
            promises.push(salvarFirebase("produtos", p)); 
        } 
        if(c) {
            c.credito = (c.credito || 0) + v.total + (v.creditoAbatido || 0);
            promises.push(salvarFirebase("clientes", c));
        }
        v.status = "Devolvido"; v.saldoDevedor = 0;
        promises.push(salvarFirebase("vendas", v));
        
        try { await Promise.all(promises); atualizar(); alert("Devolu√ß√£o processada com sucesso na Nuvem."); }
        catch(e) { alert("Falha de rede ao tentar devolver."); }
    }
};

window.darBaixaVenda = async function(id){
    let v = vendas.find(x => x.id == id);
    let pg = parseFloat(prompt(`Divida Total: ${formatCurrency(v.saldoDevedor)}\nDigite o valor pago:`, v.saldoDevedor));
    if(!isNaN(pg) && pg > 0){
        if(pg > v.saldoDevedor) return alert("O valor digitado √© maior do que a d√≠vida.");
        v.saldoDevedor = Math.max(0, Number((v.saldoDevedor - pg).toFixed(2)));
        if(!v.baixas) v.baixas = []; v.baixas.push({ valor: pg, data: new Date().toISOString() });
        if(v.saldoDevedor === 0) v.forma = "Prazo (Quitado)";
        try { await salvarFirebase("vendas", v); atualizar(); } catch(e) { alert("Erro ao baixar na internet."); }
    }
};

window.excluirVenda = async function(id){ 
    if(confirm("ATEN√á√ÉO EXCLUS√ÉO DEFINITIVA: Deseja apagar este registo para sempre?")){ 
        let promises = []; let v = vendas.find(x => x.id == id); 
        if(v && v.status !== "Devolvido"){ 
            let p = produtos.find(x => x.id == v.produtoId); 
            if(p){ 
                p.qtd += v.quantidade || 1; 
                let tDevolucao = v.tamanhoProduto || p.tam || '√önico';
                if(!p.grade) p.grade = { [p.tam || '√önico']: p.qtd - (v.quantidade||1) };
                p.grade[tDevolucao] = (p.grade[tDevolucao] || 0) + (v.quantidade || 1);
                promises.push(salvarFirebase("produtos", p)); 
            } 
        } 
        promises.push(deletarFirebase("vendas", id));
        try { await Promise.all(promises); vendas=vendas.filter(x=>x.id!=id); atualizar(); } catch(e){}
    } 
};

window.fechamentoCaixa = function(){
    let dataSelecionada = el("dataFechamentoCaixa").value;
    if(!dataSelecionada) return alert("Por favor, selecione uma data para realizar o fechamento.");

    let dataObj = new Date(dataSelecionada + "T12:00:00");
    let dataStrFiltro = dataObj.toLocaleDateString();

    let pix=0, din=0, deb=0, cre=0, baixas=0;
    
    vendas.forEach(v => {
        if(v.status !== "Devolvido" && new Date(v.data).toLocaleDateString() === dataStrFiltro){
            if(v.forma === "PIX") pix += v.total; 
            else if(v.forma.includes("Dinheiro")) din += v.total;
            else if(v.forma.includes("D√©bito")) deb += v.total; 
            else if(v.forma.includes("Cr√©dito")) cre += v.total;
        }
        
        if(v.baixas) {
            v.baixas.forEach(b => { 
                if(new Date(b.data).toLocaleDateString() === dataStrFiltro) baixas += b.valor; 
            });
        }
    });

    alert(`üìä FECHAMENTO DO DIA: ${dataStrFiltro}\n\nüí∞ Dinheiro Novo no Caixa: ${formatCurrency(pix+din+deb+cre+baixas)}\n\nEntradas Discriminadas:\n- PIX: ${formatCurrency(pix)}\n- Dinheiro: ${formatCurrency(din)}\n- Cart√µes: ${formatCurrency(deb+cre)}\n- Baixas de Fiado: ${formatCurrency(baixas)}\n\n*Valores pagos via Vale-Cr√©dito n√£o entram no Fechamento f√≠sico.`);
};

window.gerarRelatorio = function(formato) {
    let tipo = el("tipoRelatorio").value; let dIniStr = el("dataIniRel").value; let dFimStr = el("dataFimRel").value;

    let checkData = (dStringCompleta) => {
        if(!dStringCompleta) return false;
        let d = dStringCompleta.split("T")[0]; 
        if(dIniStr && d < dIniStr) return false;
        if(dFimStr && d > dFimStr) return false;
        return true;
    };

    let linhas = []; let titulo = ""; let cabecalho = [];

    if(tipo === "vendas") {
        titulo = "Historico de Vendas"; cabecalho = ["Data", "Produto", "Tamanho", "Cliente", "Forma Pagamento", "Total", "Status"];
        vendas.filter(v => (!dIniStr && !dFimStr) || checkData(v.data)).forEach(v => { linhas.push([new Date(v.data).toLocaleDateString(), v.produto, v.tamanhoProduto||"-", v.cliente, v.forma, formatCurrency(v.total), v.status||"Ativo"]); });
    } else if(tipo === "fiados") {
        titulo = "Fiados e Inadimplencia"; cabecalho = ["Data da Venda", "Cliente", "Produto", "Venda Total", "Saldo Devedor", "Vencimento"];
        vendas.filter(v => v.saldoDevedor > 0 && v.status !== "Devolvido" && ((!dIniStr && !dFimStr) || checkData(v.data))).forEach(v => {
            let venc = v.pagamentoPrevisto ? v.pagamentoPrevisto.split("-").reverse().join("/") : "Sem Data";
            linhas.push([new Date(v.data).toLocaleDateString(), v.cliente, v.produto, formatCurrency(v.total), formatCurrency(v.saldoDevedor), venc]);
        });
    } else if(tipo === "produtos") {
        titulo = "Inventario de Estoque"; cabecalho = ["Produto", "Qtd Estoque", "Custo Unitario", "Venda Unitaria", "Custo Investido", "Venda Projetada"];
        produtos.forEach(p => { linhas.push([p.nome, p.qtd, formatCurrency(p.compra), formatCurrency(p.venda), formatCurrency(p.compra * p.qtd), formatCurrency(p.venda * p.qtd)]); });
    } else if(tipo === "despesas") {
        titulo = "Despesas Operacionais"; cabecalho = ["Data", "Descricao", "Valor pago"]; let totalDesp = 0;
        despesas.filter(d => (!dIniStr && !dFimStr) || checkData(d.data)).forEach(d => { totalDesp += d.valor; linhas.push([new Date(d.data).toLocaleDateString(), d.descricao, formatCurrency(d.valor)]); });
        linhas.push(["", "TOTAL GASTO", formatCurrency(totalDesp)]);
    }

    if(linhas.length === 0) return alert("Nenhum dado encontrado para as datas selecionadas.");

    if(formato === "excel") {
        let csv = cabecalho.join(";") + "\n"; linhas.forEach(l => { csv += l.join(";") + "\n"; });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.setAttribute("download", `LAKAMI_${titulo.replace(/ /g, "_")}.csv`); link.click();
    } else if(formato === "pdf") {
        const { jsPDF } = window.jspdf; const doc = new jsPDF();
        doc.setFontSize(14); doc.text(titulo + " - LAKAMI KIDS", 14, 15);
        let dIniFormatada = dIniStr ? dIniStr.split("-").reverse().join("/") : "Inicio";
        let dFimFormatada = dFimStr ? dFimStr.split("-").reverse().join("/") : "Hoje";
        let txtPeriodo = (dIniStr || dFimStr) ? `Periodo: ${dIniFormatada} ate ${dFimFormatada}` : "Todo o periodo";
        doc.setFontSize(10); doc.text(txtPeriodo, 14, 22); doc.autoTable({ head: [cabecalho], body: linhas, startY: 28 }); doc.save(`LAKAMI_${titulo.replace(/ /g, "_")}.pdf`);
    }
};

window.imprimirRecibo = function(id){
    let v = vendas.find(x => x.id == id); if(!v) return;
    let nExibicao = v.tamanhoProduto ? `${v.produto} (Tam: ${v.tamanhoProduto})` : v.produto;
    let dataHora = new Date(v.data); let dataFormatada = dataHora.toLocaleDateString() + ' √†s ' + dataHora.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    let reciboId = v.id.toString().substring(0, 8); let valorTotalItem = v.total + (v.creditoAbatido||0);
    let html = `
    <div class="recibo-header"><h2>LAKAMI KIDS</h2><p>Instagram: @lakami_kids</p><p>WhatsApp: (82) 99381-7564</p></div>
    <div class="recibo-info"><p><b>Data:</b> ${dataFormatada}</p><p><b>Recibo N¬∫:</b> ${reciboId}</p><p><b>Cliente:</b> ${v.cliente}</p></div>
    <table class="recibo-table"><thead><tr><th>Qtd</th><th>Descri√ß√£o</th><th class="right">Total</th></tr></thead>
    <tbody><tr><td>${v.quantidade || 1}x</td><td>${nExibicao}</td><td class="right">${formatCurrency(valorTotalItem)}</td></tr></tbody></table>
    <div class="recibo-totais"><div class="linha"><span>Subtotal:</span> <span>${formatCurrency(valorTotalItem)}</span></div>
    ${v.creditoAbatido > 0 ? `<div class="linha"><span>Vale-Cr√©dito Usado:</span> <span>- ${formatCurrency(v.creditoAbatido)}</span></div>` : ''}
    <div class="linha destaque"><span>TOTAL A PAGAR:</span> <span>${formatCurrency(v.total)}</span></div>
    <div class="linha" style="margin-top:6px; font-size:11px;"><span>Forma de Pagamento:</span> <span>${v.forma}</span></div>
    ${v.saldoDevedor > 0 ? `<div class="linha" style="color:red; font-size:11px;"><span>Saldo Devedor (Fiado):</span> <span>${formatCurrency(v.saldoDevedor)}</span></div>` : ''}</div>
    <div class="recibo-footer"><p>Obrigado pela prefer√™ncia!</p><p>Trocas em at√© 30 dias, com a etiqueta fixada na pe√ßa e sem marcas de uso.</p><p>Volte sempre! ü•∞</p></div>`;
    el("reciboImpressao").innerHTML = html; document.body.className = 'print-recibo';
    setTimeout(() => { window.print(); document.body.className = ''; }, 50);
};

window.imprimirReciboCompra = function(id){
    let c = historicoCompras.find(x => x.id == id); if(!c) return;
    let dataFormatada = new Date(c.data).toLocaleDateString(); let reciboId = c.id.toString().substring(0, 8);
    let html = `
    <div class="recibo-header"><h2>LAKAMI KIDS</h2><p>COMPROVANTE DE ENTRADA</p></div>
    <div class="recibo-info"><p><b>Data de Entrada:</b> ${dataFormatada}</p><p><b>Registo N¬∫:</b> ${reciboId}</p><p><b>Fornecedor:</b> ${c.empresa}</p></div>
    <div class="recibo-totais" style="margin-top: 15px;"><div class="linha"><span>Total de Pe√ßas:</span> <span>${c.qtd} unid.</span></div><div class="linha"><span>Valor dos Produtos:</span> <span>${formatCurrency(c.valor)}</span></div><div class="linha"><span>Valor do Frete:</span> <span>${formatCurrency(c.frete)}</span></div><div class="linha destaque"><span>CUSTO TOTAL:</span> <span>${formatCurrency(c.valor + c.frete)}</span></div><div class="linha" style="margin-top:6px; font-size:11px;"><span>Forma de Pagamento:</span> <span>${c.pagamento}</span></div></div>
    <div class="recibo-footer"><p>Documento de controlo interno de stock.</p></div>`;
    el("reciboImpressao").innerHTML = html; document.body.className = 'print-recibo';
    setTimeout(() => { window.print(); document.body.className = ''; }, 50);
};

window.abrirModalRecibo = function(id) { idVendaAtualRecibo = id; el("modalRecibo").classList.remove("hidden"); };
window.fecharModalRecibo = function() { el("modalRecibo").classList.add("hidden"); idVendaAtualRecibo = null; };
window.dispararReciboWhatsApp = function() { if(idVendaAtualRecibo) window.enviarReciboWhatsApp(idVendaAtualRecibo); fecharModalRecibo(); };
window.dispararReciboPapel = function() { if(idVendaAtualRecibo) window.imprimirRecibo(idVendaAtualRecibo); fecharModalRecibo(); };

window.enviarParabensWhatsApp = function(idCliente) {
    let c = clientes.find(x => x.id == idCliente);
    if(!c || !c.tel) return alert("O cliente n√£o tem n√∫mero de WhatsApp registado.");
    let fone = c.tel.replace(/\D/g, ''); 
    if(fone.length < 10) return alert("N√∫mero de telefone inv√°lido.");
    if(!fone.startsWith('55') && fone.length <= 11) fone = '55' + fone; 
    let texto = `üéâ Ol√°, ${c.nome}! Aqui √© da Lakami Kids.\n\nVimos que este √© o m√™s do seu anivers√°rio! üéÇ\nPara celebrar, temos um presente especial √† sua espera na nossa loja.\n\nVenha visitar-nos e garanta o seu mimo especial! üõçÔ∏è‚ú®`;
    window.open(`https://wa.me/${fone}?text=${encodeURIComponent(texto)}`, '_blank');
};

window.enviarReciboWhatsApp = function(idVenda) {
    let v = vendas.find(x => x.id == idVenda); if(!v) return;
    let c = clientes.find(x => x.nome === v.cliente);
    if(!c || !c.tel) return alert("Cliente n√£o tem WhatsApp registado.");
    let fone = c.tel.replace(/\D/g, '');
    if(fone.length < 10) return alert("N√∫mero inv√°lido.");
    if(!fone.startsWith('55') && fone.length <= 11) fone = '55' + fone;
    let nExibicao = v.tamanhoProduto ? `${v.produto} (Tam: ${v.tamanhoProduto})` : v.produto;
    let txtDevedor = v.saldoDevedor > 0 ? `\n*Ficou a dever:* ${formatCurrency(v.saldoDevedor)} (Venc: ${v.pagamentoPrevisto ? v.pagamentoPrevisto.split("-").reverse().join("/") : "A combinar"})` : "";
    let texto = `Ol√°, ${v.cliente}! üõçÔ∏è Obrigado por comprar na *LAKAMI KIDS*.\n\n*Resumo da sua compra:*\nData: ${new Date(v.data).toLocaleDateString()}\nItem: ${v.quantidade || 1}x ${nExibicao}\nValor: ${formatCurrency(v.total + (v.creditoAbatido||0))}\nForma Pag.: ${v.forma}${txtDevedor}\n\nAgradecemos a prefer√™ncia! ü•∞\nüìç @lakami_kids | (82) 99381-7564`;
    window.open(`https://wa.me/${fone}?text=${encodeURIComponent(texto)}`, '_blank');
};

/* --- CAT√ÅLOGO --- */
window.abrirCatalogo = function() { produtosSelecionadosCatalogo.clear(); renderizarGridCatalogo(); el("modalCatalogo").classList.remove("hidden"); };
window.fecharCatalogo = function() { el("modalCatalogo").classList.add("hidden"); };

window.toggleSelecaoCatalogo = function(id) {
    let card = el("card-cat-" + id); let check = el("check-cat-" + id);
    if(produtosSelecionadosCatalogo.has(id)) {
        produtosSelecionadosCatalogo.delete(id); card.style.border = "1px solid #e2e8f0"; card.style.background = "#fff"; check.style.background = "#e2e8f0"; check.innerText = "";
    } else {
        produtosSelecionadosCatalogo.add(id); card.style.border = "3px solid var(--primary)"; card.style.background = "#fdf2f8"; check.style.background = "var(--primary)"; check.innerText = "‚úì";
    }
};
window.selecionarTodosCatalogo = function() { produtos.forEach(p => { if(p.qtd > 0) produtosSelecionadosCatalogo.add(p.id); }); renderizarGridCatalogo(); };
window.limparSelecaoCatalogo = function() { produtosSelecionadosCatalogo.clear(); renderizarGridCatalogo(); };

function renderizarGridCatalogo() {
    let grid = el("gridCatalogo"); grid.innerHTML = ""; let temEstoque = false;
    produtos.forEach(p => {
        if(p.qtd > 0) {
            temEstoque = true;
            let isSelected = produtosSelecionadosCatalogo.has(p.id);
            let classSelecionado = isSelected ? 'border:3px solid var(--primary); background:#fdf2f8;' : 'border:1px solid #e2e8f0; background:#fff;';
            let checkBg = isSelected ? 'var(--primary)' : '#e2e8f0'; let checkTxt = isSelected ? '‚úì' : '';
            let imgTag = p.img ? `<img src="${p.img}" style="width:100%; height:200px; object-fit:contain; background:#f8fafc; border-radius:10px; margin-bottom:12px; border:1px solid #e2e8f0;">` : `<div style="width:100%; height:200px; background:#e2e8f0; border-radius:10px; margin-bottom:12px; display:flex; align-items:center; justify-content:center; color:#94a3b8; font-weight:bold;">Sem Foto</div>`;
            let gradeObj = p.grade || { [p.tam || '√önico']: p.qtd }; let tamanhosStr = []; Object.keys(gradeObj).forEach(t => { if(gradeObj[t] > 0) tamanhosStr.push(t); });
            grid.innerHTML += `<div id="card-cat-${p.id}" onclick="toggleSelecaoCatalogo(${p.id})" style="${classSelecionado} cursor:pointer; border-radius:12px; padding:15px; text-align:center; box-shadow:0 4px 6px -1px rgba(0,0,0,.05); transition:all 0.2s; position:relative;">
                <div id="check-cat-${p.id}" style="position:absolute; top:10px; right:10px; background:${checkBg}; color:#fff; width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:16px; transition:all 0.2s;">${checkTxt}</div>
                ${imgTag}<h4 style="margin:0 0 8px 0; color:#334155; font-size:16px;">${p.nome}</h4>
                <div style="color:var(--primary); font-weight:900; font-size:20px; margin-bottom:10px;">${formatCurrency(p.venda)}</div>
                <div style="font-size:13px; color:#64748b; background:#f8fafc; padding:8px; border-radius:8px; border:1px solid #e2e8f0;">Dispon√≠vel: <span style="font-weight:700; color:#475569;">${tamanhosStr.join(', ')}</span></div></div>`;
        }
    });
    if(!temEstoque) grid.innerHTML = "<div style='grid-column: 1 / -1; text-align:center; padding:40px; color:#64748b;'>N√£o existem produtos com stock dispon√≠vel de momento.</div>";
}

window.abrirModalAcoesCatalogo = function() {
    if(produtosSelecionadosCatalogo.size === 0) return alert("Aten√ß√£o: Primeiro, toque nos produtos que deseja enviar para os selecionar.");
    el("modalAcoesCatalogo").classList.remove("hidden");
};
window.fecharModalAcoesCatalogo = function() { el("modalAcoesCatalogo").classList.add("hidden"); };

window.enviarCatalogoWhatsApp = function() {
    let txt = "‚ú® *CAT√ÅLOGO LAKAMI KIDS* ‚ú®\n_Dispon√≠vel para entrega imediata_\n\n";
    produtos.forEach(p => {
        if(p.qtd > 0 && produtosSelecionadosCatalogo.has(p.id)) {
            let gradeObj = p.grade || { [p.tam || '√önico']: p.qtd }; let tamanhosStr = []; Object.keys(gradeObj).forEach(t => { if(gradeObj[t] > 0) tamanhosStr.push(t); });
            txt += `üõçÔ∏è *${p.nome}*\nüìè Tamanhos: ${tamanhosStr.join(', ')}\nüí∞ Valor: ${formatCurrency(p.venda)}\n\n`;
        }
    });
    txt += "Pe√ßa j√° fotos detalhadas ou reserve o seu! ü•∞\nüìç Instagram: @lakami_kids\nüì≤ WhatsApp: (82) 99381-7564";
    
    let idCliente = el("selectClienteCatalogo").value; let url = "";
    if(idCliente) {
        let c = clientes.find(x => x.id == idCliente);
        if(c && c.tel) { let fone = c.tel.replace(/\D/g, ''); if(!fone.startsWith('55') && fone.length <= 11) fone = '55' + fone; url = `https://wa.me/${fone}?text=${encodeURIComponent(txt)}`; } 
        else { alert("Aten√ß√£o: A cliente selecionada n√£o tem WhatsApp. Ser√° aberto o WhatsApp gen√©rico."); url = `https://wa.me/?text=${encodeURIComponent(txt)}`; }
    } else { url = `https://wa.me/?text=${encodeURIComponent(txt)}`; }
    window.open(url, '_blank'); fecharModalAcoesCatalogo(); fecharCatalogo();
};

/* GERA√á√ÉO PDF NATIVO EXCLUSIVO P/ O CAT√ÅLOGO (Ignora Motor do Telem√≥vel) */
window.imprimirCatalogoVisualEFechar = function() {
    fecharModalAcoesCatalogo();
    try {
        const { jsPDF } = window.jspdf; const doc = new jsPDF('p', 'mm', 'a4');
        doc.setFontSize(22); doc.setTextColor(255, 78, 181); doc.text("LAKAMI KIDS - Vitrine", 105, 20, { align: "center" });
        doc.setFontSize(12); doc.setTextColor(100, 116, 139); doc.text("@lakami_kids | WhatsApp: (82) 99381-7564", 105, 28, { align: "center" });

        let yPos = 40; let xPos = 15; let colWidth = 85; let rowHeight = 90; let itemsInRow = 0;
        
        produtos.forEach(p => {
            if(p.qtd > 0 && produtosSelecionadosCatalogo.has(p.id)) {
                if (yPos + rowHeight > 280) { doc.addPage(); yPos = 20; xPos = 15; itemsInRow = 0; }

                if (p.img) {
                    try {
                        let format = p.img.split(';')[0].split('/')[1].toUpperCase();
                        if(format === 'JPG' || format === 'X-PNG') format = 'JPEG';
                        doc.addImage(p.img, format, xPos, yPos, colWidth, 60);
                    } catch (e) {
                        doc.setDrawColor(200); doc.setFillColor(248, 250, 252); doc.rect(xPos, yPos, colWidth, 60, 'FD');
                        doc.text("S/ Foto", xPos + colWidth/2, yPos + 30, {align: "center"});
                    }
                } else {
                    doc.setDrawColor(200); doc.setFillColor(248, 250, 252); doc.rect(xPos, yPos, colWidth, 60, 'FD');
                    doc.text("S/ Foto", xPos + colWidth/2, yPos + 30, {align: "center"});
                }
                
                doc.setFontSize(12); doc.setTextColor(51, 65, 85);
                let nomeCurto = p.nome.length > 30 ? p.nome.substring(0, 27) + "..." : p.nome;
                doc.text(nomeCurto, xPos + colWidth/2, yPos + 68, { align: "center" });
                
                doc.setFontSize(14); doc.setTextColor(255, 78, 181);
                doc.text(formatCurrency(p.venda), xPos + colWidth/2, yPos + 76, { align: "center" });
                
                let gradeObj = p.grade || { [p.tam || '√önico']: p.qtd };
                let tamanStr = []; Object.keys(gradeObj).forEach(t => { if(gradeObj[t] > 0) tamanStr.push(t); });
                doc.setFontSize(10); doc.setTextColor(100, 116, 139);
                doc.text("Tamanhos: " + tamanStr.join(', '), xPos + colWidth/2, yPos + 83, { align: "center" });
                
                itemsInRow++;
                if (itemsInRow >= 2) { itemsInRow = 0; xPos = 15; yPos += rowHeight; } else { xPos += colWidth + 10; }
            }
        });
        
        doc.save("Vitrine_Lakami.pdf"); fecharCatalogo();
    } catch(err) { alert("Erro de bloqueio. O seu navegador pode ter impedido a cria√ß√£o direta do PDF."); }
};

window.copiarCatalogoTextoDaModal = function() {
    let txt = "‚ú® *CAT√ÅLOGO LAKAMI KIDS* ‚ú®\n_Dispon√≠vel para entrega imediata_\n\n";
    produtos.forEach(p => {
        if(p.qtd > 0 && produtosSelecionadosCatalogo.has(p.id)) {
            let gradeObj = p.grade || { [p.tam || '√önico']: p.qtd }; let tamanhosStr = []; Object.keys(gradeObj).forEach(t => { if(gradeObj[t] > 0) tamanhosStr.push(t); });
            txt += `üõçÔ∏è *${p.nome}*\nüìè Tamanhos: ${tamanhosStr.join(', ')}\nüí∞ Valor: ${formatCurrency(p.venda)}\n\n`;
        }
    });
    txt += "Pe√ßa j√° fotos detalhadas ou reserve o seu! ü•∞\nüìç Instagram: @lakami_kids\nüì≤ WhatsApp: (82) 99381-7564";
    navigator.clipboard.writeText(txt).then(() => { alert("‚úÖ Cat√°logo em texto copiado!\nCole no WhatsApp."); fecharModalAcoesCatalogo(); fecharCatalogo(); }).catch(err => alert("Erro ao copiar."));
};

function atualizar(){
    el("listaProd").innerHTML = ""; el("pdvSelectList").innerHTML = "";
    let inv=0, est=0, vr=0, varc=0, cv=0, td=0, qtdEstoque=0, qtdVendidas=0;
    
    let mesAtual = new Date().getMonth() + 1;
    let aniversariantes = clientes.filter(c => { if(!c.nasc) return false; return parseInt(c.nasc.split('-')[1]) === mesAtual; });
    let painelAniv = el("painelAniversarios");
    if(painelAniv) {
        if(aniversariantes.length > 0) {
            let txt = '<div style="display:flex; flex-wrap:wrap; gap:10px;">' + aniversariantes.map(c => 
                `<div style="display:inline-flex; align-items:center; background:#fef9c3; padding:6px 10px; border-radius:6px; border:1px solid #fde047; gap:8px;">
                    üéÇ <b>${c.nome}</b> (${c.nasc.split('-')[2]}/${c.nasc.split('-')[1]}) 
                    <button class="whatsapp btn-acao" onclick="enviarParabensWhatsApp(${c.id})" style="padding:0 10px; margin:0;"><span style="font-size:14px; margin-right:4px;">üì≤</span> Parab√©ns</button>
                </div>`
            ).join('') + '</div>';
            painelAniv.innerHTML = `<div style="margin-bottom:12px;">üéâ <b>DICA DE CRM: Aniversariantes deste m√™s!</b> Aproveite para mandar um WhatsApp:</div>${txt}`;
            painelAniv.style.display = "block";
        } else { painelAniv.style.display = "none"; }
    }

    let fData = el("filtroDataDash") ? el("filtroDataDash").value : "Tudo";
    let checkFiltro = function(dataStr) {
        if (fData === "Tudo" || !dataStr) return true; let d = new Date(dataStr); if(isNaN(d)) return true; let hoje = new Date();
        if (fData === "Hoje") { return d.getDate() === hoje.getDate() && d.getMonth() === hoje.getMonth() && d.getFullYear() === hoje.getFullYear(); } 
        else if (fData === "Esta Semana") { let i = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate() - hoje.getDay()); return d >= i; } 
        else if (fData === "Este M√™s") { return d.getMonth() === hoje.getMonth() && d.getFullYear() === hoje.getFullYear(); } 
        else if (fData === "M√™s Passado") { let m = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1); return d.getMonth() === m.getMonth() && d.getFullYear() === m.getFullYear(); }
        return true;
    };
    
    produtos.forEach(p => {
        inv += p.compra * p.qtd; est += p.venda * p.qtd; qtdEstoque += p.qtd;
        let gradeObj = p.grade || { [p.tam || '√önico']: p.qtd }; let gradeHtmlStr = '<div style="display:flex; gap:5px; flex-wrap:wrap;">';
        Object.keys(gradeObj).forEach(t => { if(gradeObj[t] > 0) gradeHtmlStr += `<span style="background:#fdf2f8; color:#be185d; padding:4px 8px; border-radius:6px; font-size:12px; font-weight:700; border:1px solid #fbcfe8;">${t}: ${gradeObj[t]}</span>`; });
        gradeHtmlStr += '</div>'; if(p.qtd <= 0) gradeHtmlStr = `<span style="color:#ef4444; font-size:12px; font-weight:bold;">Totalmente Esgotado</span>`;

        let imgTag = p.img ? `<img src="${p.img}" style="width:70px;height:70px;border-radius:8px;object-fit:cover; border:1px solid #e2e8f0;">` : "Sem Foto";
        el("listaProd").innerHTML += `<tr><td>${imgTag}</td><td style="font-weight:600; color:#334155; white-space:normal; min-width:150px;">${p.nome}</td><td style="white-space:normal; min-width:180px;">${gradeHtmlStr}</td><td style="font-weight:900; font-size:16px; color:var(--primary);">${p.qtd}</td><td>${formatCurrency(p.compra)}</td><td>${formatCurrency(p.venda)}</td>
            <td class="acoes-btn"><button class="btn-acao" onclick="editarProduto(${p.id})">Editar</button><button class="btn-acao" onclick="document.getElementById('fileProd-${p.id}').click()" style="background:#f472b6; color:#fff;" title="Trocar Foto">Foto</button><input type="file" id="fileProd-${p.id}" style="display:none;" accept="image/*" onchange="uploadFotoDireta(event, ${p.id})"><button class="danger btn-acao-x" onclick="excluirProduto(${p.id})">X</button></td></tr>`;

        let disabled = p.qtd <= 0; let rowClass = disabled ? "select-item-row disabled" : "select-item-row"; let onclickAttr = disabled ? "" : `onclick="selecionarProdutoPDV(${p.id}, '${p.nome.replace(/'/g, "\\'")}', '${p.img || ''}')"`;
        let stockColor = disabled ? '#ef4444' : '#10b981'; let stockText = disabled ? 'Esgotado' : `${p.qtd} unid em Estoque`; let imgSmall = p.img ? `<img src="${p.img}">` : `<div class="select-item-placeholder">Sem<br>Foto</div>`;
        el("pdvSelectList").innerHTML += `<div class="${rowClass}" ${onclickAttr}>${imgSmall}<div style="flex:1"><div style="font-weight:700; font-size:15px; color:#334155;">${p.nome}</div><div style="font-size:12px; color:${stockColor}; font-weight:600; margin-top:3px;">${stockText}</div></div><div style="font-weight:900; color:var(--primary); font-size:16px;">${formatCurrency(p.venda)}</div></div>`;
    });

    el("listaClientes").innerHTML = ""; el("selectCliente").innerHTML = '<option value="">Cliente Padr√£o (Avulso)</option>';
    if(el("selectClienteCatalogo")) el("selectClienteCatalogo").innerHTML = '<option value="">Nenhum (Escolher direto no WhatsApp)</option>';
    clientes.forEach(c => { 
        let nascFormatado = c.nasc ? c.nasc.split('-').reverse().join('/') : '-'; let credFormatado = c.credito ? formatCurrency(c.credito) : 'R$ 0,00';
        el("listaClientes").innerHTML += `<tr><td>${c.nome}</td><td>${c.tel}</td><td>${nascFormatado}</td><td style="font-weight:bold; color:#166534;">${credFormatado}</td><td class="acoes-btn"><button class="btn-acao" onclick="editarCliente(${c.id})">Editar</button><button class="danger btn-acao-x" onclick="excluirCliente(${c.id})">X</button></td></tr>`; 
        el("selectCliente").innerHTML += `<option value="${c.nome}">${c.nome}</option>`; 
        if(el("selectClienteCatalogo")) el("selectClienteCatalogo").innerHTML += `<option value="${c.id}">${c.nome}</option>`;
    });

    el("listaFornecedores").innerHTML = ""; fornecedores.forEach(f => el("listaFornecedores").innerHTML += `<tr><td>${f.nome}</td><td>${f.contato}</td><td class="acoes-btn"><button class="btn-acao" onclick="editarFornecedor(${f.id})">Editar</button><button class="danger btn-acao-x" onclick="excluirFornecedor(${f.id})">X</button></td></tr>`);
    el("listaHistoricoCompras").innerHTML = ""; historicoCompras.forEach(c => el("listaHistoricoCompras").innerHTML += `<tr><td>${new Date(c.data).toLocaleDateString()}</td><td>${c.empresa}</td><td>${c.qtd}</td><td>${formatCurrency(c.valor)}</td><td>${formatCurrency(c.frete)}</td><td>${formatCurrency(c.valor+c.frete)}</td><td>${c.pagamento}</td><td class="acoes-btn"><button class="btn-acao" onclick="imprimirReciboCompra(${c.id})" style="background:#0284c7;">Recibo</button><button class="danger btn-acao-x" onclick="excluirHistoricoCompra(${c.id})">X</button></td></tr>`);
    el("listaDespesas").innerHTML = ""; despesas.forEach(d => { if(checkFiltro(d.data)) { td += d.valor; } el("listaDespesas").innerHTML += `<tr><td>${new Date(d.data).toLocaleDateString()}</td><td style="white-space:normal;">${d.descricao}</td><td>${formatCurrency(d.valor)}</td><td class="acoes-btn"><button class="danger btn-acao-x" onclick="excluirDespesa(${d.id})">X</button></td></tr>`; });

    vendas.forEach(v => { if(v.status !== "Devolvido" && checkFiltro(v.data)){ vr += (v.total - (v.saldoDevedor || 0)); varc += (v.saldoDevedor || 0); cv += v.custoHistorico || 0; qtdVendidas += (v.quantidade || 1); } });
    
    let fTotal = vr + varc;
    el("qtdEstoque").children[0].innerText = qtdEstoque; el("qtdVendidas").children[0].innerText = qtdVendidas;
    el("saldoConta").children[0].innerText = formatCurrency(vr - td); 
    el("investimento").children[0].innerText = formatCurrency(inv); el("valorEstoque").children[0].innerText = formatCurrency(est);
    el("receitas").children[0].innerText = formatCurrency(vr); el("vendasAReceber").children[0].innerText = formatCurrency(varc);
    el("despesas").children[0].innerText = formatCurrency(td);
    el("lucro").children[0].innerText = fTotal > 0 ? (((fTotal - cv - td) / fTotal) * 100).toFixed(1) + "%" : "0%";
    el("margem").children[0].innerText = fTotal > 0 ? (((fTotal - cv) / fTotal) * 100).toFixed(1) + "%" : "0%";

    el("listaVendas").innerHTML = "";
    vendas.sort((a,b)=>new Date(b.data)-new Date(a.data)).forEach(v => {
        let lVal = v.total - v.custoHistorico; let lPor = v.total > 0 ? (lVal/v.total*100).toFixed(1) : 0;
        let infoForma = v.forma; if(v.forma === "Prazo" && v.pagamentoPrevisto && v.saldoDevedor > 0){ let splitD = v.pagamentoPrevisto.split("-"); if(splitD.length === 3) infoForma = `Prazo (Venc: ${splitD[2]}/${splitD[1]})`; }
        if(v.status === "Devolvido") infoForma = `<span style="color:#ef4444; font-weight:bold;">DEVOLVIDO (Anulada)</span>`;
        let nomeExibicao = v.tamanhoProduto ? `<span style="font-weight:bold;">${v.produto}</span><br><span style="font-size:11px; color:var(--primary); font-weight:bold;">Tam: ${v.tamanhoProduto}</span>` : v.produto;
        let stVenda = v.status === "Devolvido" ? "opacity:0.6; text-decoration:line-through;" : "";

        el("listaVendas").innerHTML += `<tr style="${stVenda}"><td>${new Date(v.data).toLocaleDateString()}</td><td style="white-space:normal; min-width:140px;">${nomeExibicao}</td><td>${v.cliente}</td><td style="font-weight:bold;">${formatCurrency(v.total + (v.creditoAbatido||0))}</td><td style="color:${v.saldoDevedor>0?'red':'green'}">${formatCurrency(v.saldoDevedor || 0)}</td><td><span class="lucro-tag">${formatCurrency(lVal)} (${lPor}%)</span></td><td>${infoForma}</td>
            <td class="acoes-btn">${(v.saldoDevedor>0 && v.status !== "Devolvido") ? `<button class="success btn-acao" onclick="darBaixaVenda(${v.id})">Baixar</button>`:''}${v.status !== "Devolvido" ? `<button class="warning btn-acao" onclick="realizarTroca(${v.id})" title="Devolver e Gerar Vale-Cr√©dito">Trocar</button>`:''}<button class="btn-acao" style="background:#0284c7;" onclick="abrirModalRecibo(${v.id})">Recibo</button><button class="danger btn-acao-x" onclick="excluirVenda(${v.id})" title="Excluir">X</button></td></tr>`;
    });
}

// LIGA√á√ÉO DE FUN√á√ïES GLOBAIS
window.login=login; window.logout=logout; window.addProduto=addProduto; window.editarProduto=editarProduto; window.excluirProduto=excluirProduto; window.addCliente=addCliente; window.editarCliente=editarCliente; window.excluirCliente=excluirCliente; window.addFornecedor=addFornecedor; window.editarFornecedor=editarFornecedor; window.excluirFornecedor=excluirFornecedor; window.addHistoricoCompra=addHistoricoCompra; window.excluirHistoricoCompra=excluirHistoricoCompra; window.addDespesa=addDespesa; window.excluirDespesa=excluirDespesa; window.addCarrinho=addCarrinho; window.removerCarrinho=removerCarrinho; window.finalizarVenda=finalizarVenda; window.darBaixaVenda=darBaixaVenda; window.excluirVenda=excluirVenda; window.fechamentoCaixa=fechamentoCaixa; window.tratarRegrasPagamento=tratarRegrasPagamento; window.atualizarCarrinho=atualizarCarrinho; window.gerarRelatorio=gerarRelatorio; window.previewImage=previewImage; window.uploadFotoDireta=uploadFotoDireta; window.imprimirRecibo=imprimirRecibo; window.imprimirReciboCompra=imprimirReciboCompra; window.togglePDVDropdown=togglePDVDropdown; window.selecionarProdutoPDV=selecionarProdutoPDV; window.escolherTamanhoPDV=escolherTamanhoPDV; window.selecionarClientePDV=selecionarClientePDV; window.aplicarCreditoMaximo=aplicarCreditoMaximo; window.realizarTroca=realizarTroca; window.enviarParabensWhatsApp=enviarParabensWhatsApp; window.enviarReciboWhatsApp=enviarReciboWhatsApp; window.abrirModalRecibo=abrirModalRecibo; window.fecharModalRecibo=fecharModalRecibo; window.dispararReciboWhatsApp=dispararReciboWhatsApp; window.dispararReciboPapel=dispararReciboPapel; window.abrirCatalogo=abrirCatalogo; window.fecharCatalogo=fecharCatalogo; window.toggleSelecaoCatalogo=toggleSelecaoCatalogo; window.selecionarTodosCatalogo=selecionarTodosCatalogo; window.limparSelecaoCatalogo=limparSelecaoCatalogo; window.abrirModalAcoesCatalogo=abrirModalAcoesCatalogo; window.fecharModalAcoesCatalogo=fecharModalAcoesCatalogo; window.enviarCatalogoWhatsApp=enviarCatalogoWhatsApp; window.imprimirCatalogoVisualEFechar=imprimirCatalogoVisualEFechar; window.copiarCatalogoTextoDaModal=copiarCatalogoTextoDaModal; window.atualizar=atualizar;
</script>
</body>
</html>