<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LAKAMI PRO - Cloud PDV</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
/* ESTILOS BASE */
body{margin:0;font-family:'Roboto',sans-serif;background:#f4f6f8;color:#333}
header{background:linear-gradient(90deg,#7c3aed,#d946ef);color:#fff;padding:20px;text-align:center;font-size:26px;font-weight:700}
.container{max-width:1400px;margin:auto;padding:20px}
.card{background:#fff;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 4px 15px rgba(0,0,0,.05)}
input,select,button{padding:10px;margin:5px 0;width:100%;box-sizing:border-box;border-radius:6px;border:1px solid #ccc; font-family:inherit;}
button{background:#7c3aed;color:#fff;border:none;cursor:pointer;font-weight:500}
button:hover{background:#6b21a8}
button.danger{background:#ef4444;}
button.success{background:#10b981;}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{padding:12px 10px;border-bottom:1px solid #ddd;text-align:left}
th{background:#f3f3f3}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:15px;margin-bottom:20px}
.box{padding:20px;border-radius:10px;text-align:center;color:#fff;font-weight:700;font-size:14px;display:flex;flex-direction:column;}
.box span{font-size:20px;margin-top:8px}
#investimento{background:#f59e0b} #valorEstoque{background:#6366f1} #receitas{background:#8b5cf6} #vendasAReceber{background:#0284c7} #despesas{background:#ef4444} #lucro{background:#10b981} #margem{background:#14b8a6}
.hidden{display:none !important}
.flex{display:flex;gap:10px;flex-wrap:wrap; align-items:center;}
.flex input, .flex select{flex:1; min-width: 150px;}
.total-carrinho{font-weight:700;text-align:center;font-size:22px; color: #7c3aed; margin-bottom: 15px;}
.card-title{font-size:18px;font-weight:700;margin-bottom:15px; border-bottom: 2px solid #f4f6f8; padding-bottom: 10px; display:flex; justify-content:space-between;}
.acoes-btn {display: flex; gap: 5px;}
.acoes-btn button {padding: 6px 10px; font-size: 11px; width: auto;}
.lucro-tag { font-size: 11px; background: #dcfce7; color: #166534; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
</style>
</head>
<body>

<div id="reciboImpressao" style="display:none"></div>

<header>LAKAMI PRO - Cloud PDV</header>
<div class="container">

<div id="loginBox" class="card" style="max-width: 400px; margin: 50px auto;">
<h3 style="text-align: center;">Acesso Cloud</h3>
<input type="text" id="user" placeholder="Usuário">
<input type="password" id="pass" placeholder="Senha">
<button onclick="login()">Entrar</button>
</div>

<div id="sistema" class="hidden">

<div class="card">
<h3 class="card-title">Dashboard Operacional</h3>
<div class="grid">
<div class="box" id="investimento">Custo Estoque<span>R$ 0,00</span></div>
<div class="box" id="valorEstoque">Venda Projetada<span>R$ 0,00</span></div>
<div class="box" id="receitas">Total Recebido<span>R$ 0,00</span></div>
<div class="box" id="vendasAReceber">A Receber (Fiado)<span>R$ 0,00</span></div>
<div class="box" id="despesas">Despesas<span>R$ 0,00</span></div>
<div class="box" id="lucro">Lucro Líquido<span>R$ 0,00</span></div>
<div class="box" id="margem">Margem Global<span>0%</span></div>
</div>
</div>

<div class="card">
    <h3 class="card-title">Produtos</h3>
    <div class="flex">
        <input id="nomeProd" placeholder="Nome">
        <select id="tamProd"></select>
        <input id="compraProd" type="number" placeholder="Custo">
        <input id="vendaProd" type="number" placeholder="Venda">
        <input id="qtdProd" type="number" placeholder="Estoque">
        <button onclick="addProduto()">Salvar</button>
    </div>
    <table id="tabelaProd">
        <thead><tr><th>Produto</th><th>Tam</th><th>Qtd</th><th>Custo</th><th>Venda</th><th>Ações</th></tr></thead>
        <tbody id="listaProd"></tbody>
    </table>
</div>

<div class="card">
    <h3 class="card-title">PDV</h3>
    <div class="flex">
        <select id="selectProd" style="flex:2"></select>
        <input id="qtdVenda" type="number" value="1" style="max-width:80px">
        <button onclick="addCarrinho()" style="width:auto">Adicionar</button>
    </div>
    <table><tbody id="carrinho"></tbody></table>
    <div class="total-carrinho" id="totalCarrinho">Total: R$ 0,00</div>
    <div class="flex">
        <select id="selectCliente"></select>
        <select id="formaPag" onchange="tratarRegrasPagamento()">
            <option value="PIX">PIX</option>
            <option value="À vista (Dinheiro)">À vista</option>
            <option value="Cartão de Crédito">Cartão de Crédito</option>
            <option value="Prazo">A Prazo / Fiado</option>
        </select>
        <input type="number" id="valorDesconto" placeholder="Desconto %" value="0">
        <input type="date" id="dataPrazo" class="hidden">
        <button onclick="finalizarVenda()" class="success">Finalizar</button>
    </div>
</div>

<div class="card">
<h3 class="card-title">Histórico de Vendas (Com Margem Simples por Item)</h3>
<table>
<thead><tr><th>Data</th><th>Produto</th><th>Cliente</th><th>Total Venda</th><th>Saldo Devido</th><th>Lucro Simples</th><th>Ações</th></tr></thead>
<tbody id="listaVendas"></tbody>
</table>
</div>

</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getFirestore, collection, getDocs, setDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAHwt8eGsCv2dnKAYQa0iaqWoHyGxl5V14",
  authDomain: "lakami-pro.firebaseapp.com",
  projectId: "lakami-pro",
  storageBucket: "lakami-pro.firebasestorage.app",
  messagingSenderId: "966421239270",
  appId: "1:966421239270:web:60d9b7c79ba700c515f227"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const formatCurrency = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v);
const el = (id) => document.getElementById(id);

let produtos = [], clientes = [], vendas = [], despesas = [], carrinhoArr = [];
let editProdId=null;

// Preenche tamanhos
const tamSelect = el("tamProd");
tamSelect.innerHTML = `<option value="">Tamanho...</option><option value="Único">Único</option>`;
for(let i=1; i<=12; i++){ tamSelect.innerHTML += `<option value="${i}">${i}</option>`; }

async function puxarDadosNuvem() {
    const fetchCol = async (n) => {
        const snap = await getDocs(collection(db, n));
        return snap.docs.map(d => d.data());
    };
    produtos = await fetchCol("produtos");
    clientes = await fetchCol("clientes");
    vendas = await fetchCol("vendas");
    despesas = await fetchCol("despesas");
}

async function salvarFirebase(col, item) { await setDoc(doc(db, col, item.id.toString()), item); }
async function deletarFirebase(col, id) { await deleteDoc(doc(db, col, id.toString())); }

window.login = async function(){
    if(el("user").value==="admin" && el("pass").value==="1234"){ 
        await puxarDadosNuvem();
        el("loginBox").classList.add("hidden"); el("sistema").classList.remove("hidden");
        atualizar(); 
    } else alert("Erro!");
};

window.addProduto = function(){
    const n = el("nomeProd").value; const c = parseFloat(el("compraProd").value); const v = parseFloat(el("vendaProd").value); const q = parseInt(el("qtdProd").value);
    if(!n || isNaN(c)) return;
    let obj = editProdId ? produtos.find(x => x.id == editProdId) : {id: Date.now()};
    obj.nome=n; obj.tam=el("tamProd").value; obj.compra=c; obj.venda=v; obj.qtd=q;
    if(!editProdId) produtos.push(obj);
    salvarFirebase("produtos", obj);
    editProdId=null; atualizar();
};

window.addCarrinho = function(){
    let pid = el("selectProd").value; let p = produtos.find(x => x.id == pid);
    carrinhoArr.push({id: p.id, nome: p.nome, qtd: parseInt(el("qtdVenda").value), venda: p.venda, compra: p.compra});
    window.atualizarCarrinho();
};

window.atualizarCarrinho = function(){
    let st = 0; carrinhoArr.forEach(i => st += (i.qtd * i.venda));
    let desc = parseFloat(el("valorDesconto").value) || 0;
    el("totalCarrinho").innerText = "Total: " + formatCurrency(st * (1 - desc/100));
};

window.finalizarVenda = function(){
    let f = el("formaPag").value; let desc = parseFloat(el("valorDesconto").value) || 0;
    carrinhoArr.forEach(item => {
        let p = produtos.find(x => x.id == item.id); if(p) { p.qtd -= item.qtd; salvarFirebase("produtos", p); }
        let total = (item.venda * item.qtd) * (1 - (desc/100));
        let vObj = {
            id: Date.now() + Math.random(), data: new Date().toISOString(),
            produto: item.nome, cliente: el("selectCliente").value || "Avulso",
            total: total, custo: item.compra * item.qtd,
            saldoDevedor: (f === "Prazo" ? total : 0),
            forma: f
        };
        vendas.push(vObj); salvarFirebase("vendas", vObj);
    });
    carrinhoArr = []; atualizar();
};

// FUNÇÃO DE BAIXA PARCIAL (A pedido do usuário)
window.darBaixaVenda = function(id){
    let v = vendas.find(x => x.id == id);
    let valorPago = parseFloat(prompt(`Valor devido: ${formatCurrency(v.saldoDevedor)}\nQuanto o cliente está pagando hoje?`, v.saldoDevedor));
    
    if(!isNaN(valorPago) && valorPago > 0){
        if(valorPago > v.saldoDevedor) { alert("Valor maior que a dívida!"); return; }
        
        v.saldoDevedor -= valorPago;
        
        // Se quitou tudo, muda o status da forma de pagamento
        if(v.saldoDevedor <= 0){
            v.forma = "Prazo (Quitado)";
            v.saldoDevedor = 0;
        }
        
        salvarFirebase("vendas", v);
        atualizar();
    }
};

window.tratarRegrasPagamento = () => { el("dataPrazo").className = el("formaPag").value === "Prazo" ? "" : "hidden"; };

function atualizar(){
    let inv=0, est=0, vr=0, varc=0;
    el("listaProd").innerHTML = ""; el("selectProd").innerHTML = "";
    produtos.forEach(p => {
        inv += p.compra * p.qtd; est += p.venda * p.qtd;
        el("listaProd").innerHTML += `<tr><td>${p.nome}</td><td>${p.tam}</td><td>${p.qtd}</td><td>${formatCurrency(p.compra)}</td><td>${formatCurrency(p.venda)}</td><td><button onclick="editProdId=${p.id}">E</button></td></tr>`;
        el("selectProd").innerHTML += `<option value="${p.id}">${p.nome}</option>`;
    });

    el("listaVendas").innerHTML = "";
    vendas.sort((a,b)=>new Date(b.data)-new Date(a.data)).forEach(v => {
        vr += (v.total - v.saldoDevedor);
        varc += v.saldoDevedor;
        
        // CÁLCULO DE LUCRO SIMPLES POR ITEM (A pedido do usuário)
        let lucroValor = v.total - v.custo;
        let lucroPorc = v.total > 0 ? (lucroValor / v.total * 100).toFixed(1) : 0;

        let statusCor = v.saldoDevedor > 0 ? "color:red; font-weight:bold" : "color:green";
        let btnBaixa = v.saldoDevedor > 0 ? `<button class="success" onclick="darBaixaVenda(${v.id})">Baixar R$</button>` : "";

        el("listaVendas").innerHTML += `<tr>
            <td>${new Date(v.data).toLocaleDateString()}</td>
            <td>${v.produto}</td>
            <td>${v.cliente}</td>
            <td>${formatCurrency(v.total)}</td>
            <td style="${statusCor}">${formatCurrency(v.saldoDevedor)}</td>
            <td><span class="lucro-tag">${formatCurrency(lucroValor)} (${lucroPorc}%)</span></td>
            <td class="acoes-btn">${btnBaixa} <button class="danger" onclick="excluirVenda(${v.id})">X</button></td>
        </tr>`;
    });

    el("investimento").children[0].innerText = formatCurrency(inv);
    el("valorEstoque").children[0].innerText = formatCurrency(est);
    el("receitas").children[0].innerText = formatCurrency(vr);
    el("vendasAReceber").children[0].innerText = formatCurrency(varc);
    el("lucro").children[0].innerText = formatCurrency(vr - (vendas.reduce((acc,v)=>acc+v.custo,0)) );
}

// Vinculação global
window.addProduto = addProduto; window.addCarrinho = addCarrinho; window.finalizarVenda = finalizarVenda;
window.tratarRegrasPagamento = tratarRegrasPagamento; window.darBaixaVenda = darBaixaVenda;
</script>
</body>
</html>